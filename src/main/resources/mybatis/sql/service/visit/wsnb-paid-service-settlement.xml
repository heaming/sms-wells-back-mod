<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.visit.mapper.WsnbPaidServiceSettlementMapper">

    <select id="selectSvCsBilBas" resultType="java.lang.Integer">
        SELECT NVL(BIL_CTR_SUM_AMT, 0) AS BIL_CTR_SUM_AMT /* 청구조정합계금액 */
          FROM TB_SVPD_SV_CS_BIL_BAS /* 서비스비용청구기본 */
         WHERE CS_BIL_NO = #{csBilNo} /* 비용청구번호 */
    </select>

    <update id="updateSvCsBilBas">
         UPDATE TB_SVPD_SV_CS_BIL_BAS /* 서비스비용청구기본 */
            SET
            <if test="@MybatisUtils@equals(reqPrgsStatCd, '1') ">
                RVE_AK_NO = #{rveAkNo} /* 수납요청번호 */
              , STLM_PRGS_STAT_CD = '01' /* 결제진행상태코드 ("01" 청구등록) */
            </if>
            <if test="!@MybatisUtils@equals(reqPrgsStatCd, '1')">
                STLM_PRGS_STAT_CD = #{stlmPrgsStatCd} /* 결제진행상태코드 ("02" 청구취소, "03" 청구승인) */
            </if>
              <include refid="COMMON.updateSystemField"/>
          WHERE 1 = 1
            AND CS_BIL_NO = #{csBilNo} /* 비용청구번호 */
    </update>

    <update id="updateSvCsBilIz">
        UPDATE TB_SVPD_SV_CS_BIL_IZ /* 서비스비용청구내역 */
           SET ADP_BIL_STAT_CD = #{adpBilStatCd} /* 합산청구상태코드 */
             <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND CNTR_NO = #{cntrNo} /* 계약번호 */
           AND CNTR_SN = ${cntrSn} /* 계약일련번호 */
           AND CST_SV_ASN_NO = #{cstSvAsnNo} /* 고객서비스배정번호 */
    </update>

    <insert id="mergeSvCsDpIz">
        MERGE INTO TB_SVPD_SV_CS_DP_IZ T1 /* 서비스비용입금내역 */
        USING (SELECT #{cntrNo} AS CNTR_NO             /* 계약번호 */
                    , ${cntrSn} AS CNTR_SN             /* 계약일련번호 */
                    , #{csBilNo} AS CS_BIL_NO          /* 비용청구번호 */
                    , #{cstSvAsnNo} AS CST_SV_ASN_NO   /* 고객서비스배정번호 */
                    , NVL(TO_NUMBER(#{dpSn}), NULL) AS DP_SN                 /* 입금일련번호 */
                    , NVL(#{stlmDvCd}, NULL) AS STLM_DV_CD        /* 결제구분코드 */
                    , NVL(TO_NUMBER(#{dpSplAmt}), NULL) AS DP_SPL_AMT        /* 입금공급금액 */
                    , NVL(TO_NUMBER(#{dpVat}), NULL) AS DP_VAT               /* 입금부가가치세 */
                    , NVL(TO_NUMBER(#{dpSumAmt}), NULL) AS DP_SUM_AMT        /* 입금합계금액 */
                    , NVL(#{dpDtm}, NULL) AS DP_DTM               /* 입금일시 */
                    , NVL(#{trdIdno}, NULL) AS TRD_IDNO           /* 거래고유번호 */
                    , NVL(#{crcdonrNm}, NULL) AS CRCDONR_NM       /* 신용카드주명 */
                    , NVL(#{crcdnoEncr}, NULL) AS CRCDNO_ENCR     /* 신용카드번호암호화 */
                    , NVL(#{crdcdExpdtYm}, NULL) AS CRDCD_EXPDT_YM /* 신용카드유효기간년월 */
                    , NVL(TO_NUMBER(#{istmMcn}), NULL) AS ISTM_MCN           /* 할부개월수 */
                    , NVL(#{cardAprno}, NULL) AS CARD_APRNO       /* 카드승인번호 */
                    , NVL(#{iscmpCd}, NULL) AS ISCMP_CD           /* 발급사코드 */
                    , NVL(#{canDvCd}, NULL) AS CAN_DV_CD          /* 취소구분코드 */
                    , NVL(#{vacNo}, NULL) AS VAC_NO               /* 가상계좌번호 */
                    , NVL(#{vacBnkCd}, NULL) AS VAC_BNK_CD        /* 가상계좌은행코드 */
                    , NVL(#{itgDpNo}, NULL) AS ITG_DP_NO          /* 통합입금번호 */
                    , 'N' AS DTA_DL_YN                 /* 데이터삭제여부 */
                 FROM DUAL) T2
           ON (T1.CNTR_NO = T2.CNTR_NO /* 계약번호 */
          AND T1.CNTR_SN = T2.CNTR_SN /* 계약일련번호 */
          AND T1.CS_BIL_NO = T2.CS_BIL_NO /* 비용청구번호 */
          AND T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO /* 고객서비스배정번호 */
          AND T1.DP_SN = T2.DP_SN /* 입금일련번호 */ )
         WHEN MATCHED THEN
       UPDATE
          SET STLM_DV_CD = T2.STLM_DV_CD
            , DP_SPL_AMT = T2.DP_SPL_AMT
            , DP_VAT = T2.DP_VAT
            , DP_SUM_AMT = T2.DP_SUM_AMT
            , DP_DTM = T2.DP_DTM
            , TRD_IDNO = T2.TRD_IDNO
            , CRCDONR_NM = T2.CRCDONR_NM
            , CRCDNO_ENCR = T2.CRCDNO_ENCR
            , CRDCD_EXPDT_YM = T2.CRDCD_EXPDT_YM
            , ISTM_MCN = T2.ISTM_MCN
            , CARD_APRNO = T2.CARD_APRNO
            , ISCMP_CD = T2.ISCMP_CD
            , CAN_DV_CD = T2.CAN_DV_CD
            , VAC_NO = T2.VAC_NO
            , VAC_BNK_CD = T2.VAC_BNK_CD
            , ITG_DP_NO = T2.ITG_DP_NO
            , DTA_DL_YN = T2.DTA_DL_YN
            <include refid="COMMON.updateSystemField"/>
         WHEN NOT MATCHED THEN
       INSERT (CNTR_NO
            , CNTR_SN
            , CS_BIL_NO
            , CST_SV_ASN_NO
            , DP_SN
            , STLM_DV_CD
            , DP_SPL_AMT
            , DP_VAT
            , DP_SUM_AMT
            , DP_DTM
            , TRD_IDNO
            , CRCDONR_NM
            , CRCDNO_ENCR
            , CRDCD_EXPDT_YM
            , ISTM_MCN
            , CARD_APRNO
            , ISCMP_CD
            , CAN_DV_CD
            , VAC_NO
            , VAC_BNK_CD
            , ITG_DP_NO
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" /> )
       VALUES (T2.CNTR_NO
            , T2.CNTR_SN
            , T2.CS_BIL_NO
            , T2.CST_SV_ASN_NO
            , (SELECT NVL(MAX(DP_SN), 0) + 1
                 FROM TB_SVPD_SV_CS_DP_IZ
                WHERE CNTR_NO = T2.CNTR_NO
                  AND CNTR_SN = T2.CNTR_SN
                  AND CS_BIL_NO = T2.CS_BIL_NO
                  AND CST_SV_ASN_NO = T2.CST_SV_ASN_NO)
            , T2.STLM_DV_CD
            , T2.DP_SPL_AMT
            , T2.DP_VAT
            , T2.DP_SUM_AMT
            , T2.DP_DTM
            , T2.TRD_IDNO
            , T2.CRCDONR_NM
            , T2.CRCDNO_ENCR
            , T2.CRDCD_EXPDT_YM
            , T2.ISTM_MCN
            , T2.CARD_APRNO
            , T2.ISCMP_CD
            , T2.CAN_DV_CD
            , T2.VAC_NO
            , T2.VAC_BNK_CD
            , T2.ITG_DP_NO
            , T2.DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <insert id="mergeSvCsCrdcdPcsIz">
        MERGE INTO TB_SVPD_SV_CS_CRDCD_PCS_IZ T1 /* 서비스비용신용카드처리내역 */
        USING (SELECT #{csBilNo} AS CS_BIL_NO              /* 비용청구번호 */
                    , NVL(TO_NUMBER(#{csBilSn}), NULL) AS CS_BIL_SN   /* 비용청구일련번호 */
                    , NVL(#{msgno}, NULL) AS MSGNO                    /* 전문번호 */
                    , NVL(TO_NUMBER(#{etxtSn}), NULL) AS ETXT_SN      /* 전문일련번호 */
                    , NVL(#{aprDvCd}, NULL) AS APR_DV_CD              /* 승인구분코드 */
                    , NVL(#{cardFntImpsCd}, NULL) AS CARD_FNT_IMPS_CD /* 카드이체불능코드 */
                    , NVL(#{trdIdno}, NULL) AS TRD_IDNO               /* 거래고유번호 */
                    , NVL(#{crcdnoEncr}, NULL) AS CRCDNO_ENCR         /* 신용카드번호암호화 */
                    , NVL(#{crdcdExpdtYm}, NULL) AS CRDCD_EXPDT_YM    /* 신용카드유효기간년월 */
                    , NVL(TO_NUMBER(#{istmMcn}), NULL) AS ISTM_MCN    /* 할부개월수 */
                    , NVL(TO_NUMBER(#{cardAprAmt}), NULL) AS CARD_APR_AMT /* 카드승인금액 */
                    , NVL(#{cardAprno}, NULL) AS CARD_APRNO           /* 카드승인번호 */
                    , NVL(#{aprDtm}, NULL) AS APR_DTM                 /* 승인일시 */
                    , NVL(#{iscmpCd}, NULL) AS ISCMP_CD               /* 발급사코드 */
                    , NVL(#{canDvCd}, NULL) AS CAN_DV_CD              /* 취소구분코드 */
                    , 'N' AS DTA_DL_YN                     /* 데이터삭제여부 */
                 FROM DUAL) T2
           ON (T1.CS_BIL_NO = T2.CS_BIL_NO /* 비용청구번호 */
          AND T1.CS_BIL_SN = T2.CS_BIL_SN /* 비용청구일련번호 */)
         WHEN MATCHED THEN
       UPDATE
          SET MSGNO = T2.MSGNO
            , ETXT_SN = T2.ETXT_SN
            , APR_DV_CD = T2.APR_DV_CD
            , CARD_FNT_IMPS_CD = T2.CARD_FNT_IMPS_CD
            , TRD_IDNO = T2.TRD_IDNO
            , CRCDNO_ENCR = T2.CRCDNO_ENCR
            , CRDCD_EXPDT_YM = T2.CRDCD_EXPDT_YM
            , ISTM_MCN = T2.ISTM_MCN
            , CARD_APR_AMT = T2.CARD_APR_AMT
            , CARD_APRNO = T2.CARD_APRNO
            , APR_DTM = T2.APR_DTM
            , ISCMP_CD = T2.ISCMP_CD
            , CAN_DV_CD = T2.CAN_DV_CD
            , DTA_DL_YN = T2.DTA_DL_YN
            <include refid="COMMON.updateSystemField"/>
         WHEN NOT MATCHED THEN
       INSERT (CS_BIL_NO
            , CS_BIL_SN
            , MSGNO
            , ETXT_SN
            , APR_DV_CD
            , CARD_FNT_IMPS_CD
            , TRD_IDNO
            , CRCDNO_ENCR
            , CRDCD_EXPDT_YM
            , ISTM_MCN
            , CARD_APR_AMT
            , CARD_APRNO
            , APR_DTM
            , ISCMP_CD
            , CAN_DV_CD
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" /> )
      VALUES (T2.CS_BIL_NO
            , (SELECT NVL(MAX(CS_BIL_SN), 0) + 1
                 FROM TB_SVPD_SV_CS_CRDCD_PCS_IZ
                WHERE CS_BIL_NO = T2.CS_BIL_NO)
            , T2.MSGNO
            , T2.ETXT_SN
            , T2.APR_DV_CD
            , T2.CARD_FNT_IMPS_CD
            , T2.TRD_IDNO
            , T2.CRCDNO_ENCR
            , T2.CRDCD_EXPDT_YM
            , T2.ISTM_MCN
            , T2.CARD_APR_AMT
            , T2.CARD_APRNO
            , T2.APR_DTM
            , T2.ISCMP_CD
            , T2.CAN_DV_CD
            , T2.DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <insert id="mergeSvCsVacPcsIz">
        MERGE INTO TB_SVPD_SV_CS_VAC_PCS_IZ T1 /* 서비스비용가상계좌처리내역 */
        USING (SELECT #{csBilNo} AS CS_BIL_NO                       /* 비용청구번호 */
                    , NVL(TO_NUMBER(#{csBilSn}), NULL) AS CS_BIL_SN /* 비용청구일련번호 */
                    , NVL(#{rveCoCd}, NULL) AS RVE_CO_CD            /* 수납회사코드 */
                    , NVL(#{etxtAkDt}, NULL) AS ETXT_AK_DT          /* 전문요청일자 */
                    , NVL(TO_NUMBER(#{etxtAkSn}), NULL) AS ETXT_AK_SN /* 전문요청일련번호 */
                    , NVL(#{vacDpErrCd}, NULL) AS VAC_DP_ERR_CD     /* 가상계좌입금오류코드 */
                    , NVL(#{vacNo}, NULL) AS VAC_NO                 /* 가상계좌번호 */
                    , NVL(#{vacBnkCd}, NULL) AS VAC_BNK_CD          /* 가상계좌은행코드 */
                    , NVL(TO_NUMBER(#{vacStlmAmt}), NULL) AS VAC_STLM_AMT /* 가상계좌결제금액 */
                    , 'N' AS DTA_DL_YN                              /* 데이터삭제여부 */
                 FROM DUAL) T2
           ON (T1.CS_BIL_NO = T2.CS_BIL_NO /* 비용청구번호 */
          AND T1.CS_BIL_SN = T2.CS_BIL_SN /* 비용청구일련번호 */ )
         WHEN MATCHED THEN
       UPDATE
          SET RVE_CO_CD = T2.RVE_CO_CD
            , ETXT_AK_DT = T2.ETXT_AK_DT
            , ETXT_AK_SN = T2.ETXT_AK_SN
            , VAC_DP_ERR_CD = T2.VAC_DP_ERR_CD
            , VAC_NO = T2.VAC_NO
            , VAC_BNK_CD = T2.VAC_BNK_CD
            , VAC_STLM_AMT = T2.VAC_STLM_AMT
            , DTA_DL_YN = T2.DTA_DL_YN
            <include refid="COMMON.updateSystemField"/>
         WHEN NOT MATCHED THEN
       INSERT (CS_BIL_NO
            , CS_BIL_SN
            , RVE_CO_CD
            , ETXT_AK_DT
            , ETXT_AK_SN
            , VAC_DP_ERR_CD
            , VAC_NO
            , VAC_BNK_CD
            , VAC_STLM_AMT
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" /> )
       VALUES (T2.CS_BIL_NO
            , (SELECT NVL(MAX(CS_BIL_SN), 0) + 1
                 FROM TB_SVPD_SV_CS_VAC_PCS_IZ
                WHERE CS_BIL_NO = T2.CS_BIL_NO)
            , T2.RVE_CO_CD
            , T2.ETXT_AK_DT
            , T2.ETXT_AK_SN
            , T2.VAC_DP_ERR_CD
            , T2.VAC_NO
            , T2.VAC_BNK_CD
            , T2.VAC_STLM_AMT
            , T2.DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

</mapper>
