<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.changeorder.mapper.WctbCustomerBaseBulkChangeMapper">
    <select id="selectBulkChangeObjects" resultType="com.kyowon.sms.wells.web.contract.changeorder.dvo.WctbCustomerBaseBulkChangeDvo">
        /* 고객기준 일괄변경 대상 조회(자동이체,설치자명,세금계산서발행여부) */
        SELECT T1.SELL_PRTNR_NO /* 판매파트너번호 */
             , T1.COPN_DV_CD /* 법인격구분코드 */
             , T3.PRTNR_KNM /* [이름] 파트너한글명 */
             , T2.SELL_TP_CD /* 판매유형코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T2.SELL_TP_CD) AS SELL_TP_NM /* [업무구분] 판매유형명 */
             , T2.CNTR_NO /* [계약번호] */
             , T2.CNTR_SN /* [일련번호] 계약일련번호 */
             , T4.CST_KNM /* [고객명] 고객한글명 */
             , T1.CNTR_CNFM_DTM /* [접수일자] 계약확정일시 */
             , T1.CNTR_CST_NO /* [고객번호] 계약고객번호 */
             , T2.TXINV_PBL_OJ_YN /* [세금계산서] 세금계산서발행대상여부 */
             , T5.EMADR /* [이메일] 이메일주소 */
             , CASE WHEN T6.DP_TP_CD = '0102' /* 계좌 */ THEN F_CMZ_CD_NM('TNT_WELLS', 'AC_FNT_IMPS_CD', T7.AC_FNT_IMPS_CD) /* 계좌이체불능코드 */
                    WHEN T6.DP_TP_CD = '0203' /* 카드 */ THEN F_CMZ_CD_NM('TNT_WELLS', 'CARD_FNT_IMPS_CD', T7.CARD_FNT_IMPS_CD) /* 카드이체불능코드 */
                    WHEN T6.DP_TP_CD IN ('0101' /* 가상계좌 */, '0401' /*지로*/) THEN '정상'
                    ELSE '알수없음'
               END AS ATMT_STAT /* [자동이체정보-상태] */
             , T7.MPY_BSDT /* [자동이체정보-이체일] 납부기준일자 */
             , CASE WHEN T2.CNTR_DTL_STAT_CD IN ('301','302','303') THEN T2.CNTR_DTL_STAT_CD
                    ELSE
                         CASE WHEN T6.STLM_HD_DV_CD = 'N' THEN 'N' /* 보류*/
                              ELSE
                                   CASE WHEN T6.DP_TP_CD = '0101' THEN 'S' /* 가상계좌*/
                                        WHEN T6.DP_TP_CD = '0102' THEN '1' /* 은행*/
                                        WHEN T6.DP_TP_CD = '0203' THEN '2' /* 카드*/
                                        WHEN T6.DP_TP_CD = '0401' THEN 'G' /* 지로*/
                                        ELSE ''
                                        END
                              END
                    END AS AFTN_INF_FNT_DV_CD /* 이체구분코드 */
             , CASE WHEN T2.CNTR_DTL_STAT_CD IN ('301','302','303') THEN ''
                    ELSE
                         CASE WHEN T6.STLM_HD_DV_CD = 'N' THEN '보류'
                              ELSE
                                   CASE WHEN T6.DP_TP_CD = '0101' THEN '가상계좌'
                                        WHEN T6.DP_TP_CD = '0102' THEN '은행'
                                        WHEN T6.DP_TP_CD = '0203' THEN '카드'
                                        WHEN T6.DP_TP_CD = '0401' THEN '지로'
                                        ELSE ''
                                        END
                              END
                    END AS AFTN_INF_FNT_DV_NM /* 이체구분명 */
             , T6.DP_TP_CD /* 입금유형코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', T6.DP_TP_CD) AS DP_TP_NM /* [자동이체정보-이체구분] 입금유형명 */
             , CASE WHEN T6.DP_TP_CD = '0102' THEN T7.BNK_CD
                    WHEN T6.DP_TP_CD = '0203' THEN T7.CDCO_CD
               END AS BNK_CDCO_CD /* 은행/카드사코드 */
             , CASE WHEN T6.DP_TP_CD = '0102' THEN F_CMZ_CD_NM('TNT_WELLS', 'BNK_CD', T7.BNK_CD)
                     WHEN T6.DP_TP_CD = '0203' THEN F_CMZ_CD_NM('TNT_WELLS', 'CDCO_CD', T7.CDCO_CD)
                END AS BNK_CDCO_NM /* [자동이체정보-카드사/은행] 은행/카드사명 */
             , CASE WHEN T6.DP_TP_CD = '0102' THEN T7.ACNO_ENCR /* 계좌번호암호화 */
                    WHEN T6.DP_TP_CD = '0203' THEN T7.CRCDNO_ENCR /* 신용카드번호암호화 */
               END AS ACNO_CRCDNO /* [자동이체정보-카드/계좌번호] */
             , CASE WHEN T6.DP_TP_CD = '0102' AND T8.DG_CNTR_NO IS NOT NULL THEN 'Y'
                    WHEN T6.DP_TP_CD = '0203' AND T9.DG_CNTR_NO IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END AS IS_BNDL /* [자동이체정보-묶음/대표] 묶음출금여부 */
             , CASE WHEN T6.DP_TP_CD = '0102' AND T8.DG_CNTR_NO IS NOT NULL AND T8.DG_YN = 'Y' THEN 'Y'
                    WHEN T6.DP_TP_CD = '0203' AND T9.DG_CNTR_NO IS NOT NULL AND T9.DG_YN = 'Y' THEN 'Y'
                    ELSE 'N'
               END AS IS_BNDL_MAST /* [자동이체정보-묶음/대표] 묶음출금 대표주문 여부 */
             , T6.CNTR_STLM_ID /* 계약결제ID */
             , '하단 증빙원본 조회' AS EVID_OCY_INQR /* [자동이체정보-선택] */
             , '해지' AS RESIGN /* [자동이체정보-해지] */
             , T10.RCGVP_KNM AS IST_KNM /* [설치자 정보-설치고객명] 수령자한글명 */
             , T10.CRAL_LOCARA_TNO AS W_CRAL_LOCARA_TNO /* [설치자 정보-휴대전화번호1] */
             , T10.MEXNO_ENCR AS W_MEXNO_ENCR /* [설치자 정보-휴대전화번호2] */
             , T10.CRAL_IDV_TNO AS W_CRAL_IDV_TNO /* [설치자 정보-휴대전화번호3] */
             , T10.LOCARA_TNO AS W_LOCARA_TNO /* [설치자 정보-전화번호1] */
             , T10.EXNO_ENCR AS W_EXNO_ENCR /* [설치자 정보-전화번호2] */
             , T10.IDV_TNO AS W_IDV_TNO /* [설치자 정보-전화번호3] */
             , T10.ADR_ZIP AS W_ADR_ZIP /* [설치자 정보-우편번호] */
             , T10.RNADR AS W_RNADR /* [설치자 정보-주소1] 주소 */
             , T10.RDADR AS W_RDADR /* [설치자 정보-주소2] 상세주소 */
             , T11.CRAL_LOCARA_TNO /* [계약자 정보-휴대전화번호1] */
             , T11.MEXNO_ENCR /* [계약자 정보-휴대전화번호2] */
             , T11.CRAL_IDV_TNO /* [계약자 정보-휴대전화번호3] */
             , T11.LOCARA_TNO /* [계약자 정보-전화번호1] */
             , T11.EXNO_ENCR /* [계약자 정보-전화번호2] */
             , T11.IDV_TNO /* [계약자 정보-전화번호3] */
             , T11.ADR_ZIP /* [계약자 정보-우편번호] */
             , T11.RNADR /* [계약자 정보-주소1] */
             , T11.RDADR /* [계약자 정보-주소2] */
             , CASE WHEN T6.DP_TP_CD = '0102' AND T8.DG_CNTR_NO IS NOT NULL THEN T8.DG_CNTR_NO
                    WHEN T6.DP_TP_CD = '0203' AND T9.DG_CNTR_NO IS NOT NULL THEN T9.DG_CNTR_NO
                    ELSE '0'
               END AS RPRS_CNTR_NO /* 묶음출금 대표계약번호 */
          FROM TB_SSCT_CNTR_BAS T1 /*계약기본*/
         INNER JOIN TB_SSCT_CNTR_DTL T2 /*계약상세*/
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
           AND T2.SELL_TP_CD IN ('1','2','3','6') /*1:일시불 2:렌탈 3:멤버십 6:정기배송*/
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T3 /* 월파트너내역 */
            ON T3.BASE_YM = SUBSTR(T1.CNTR_CNFM_DTM, 1, 6)
           AND T3.OG_TP_CD = T1.SELL_OG_TP_CD
           AND T3.PRTNR_NO = T1.SELL_PRTNR_NO
           AND T3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS T4 /* 고객기본 */
            ON T4.CST_NO = T1.CNTR_CST_NO
           AND T4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_TXINV_RCP_BASE_IZ T5 /* 세금계산서접수기준내역 */
            ON T5.CNTR_NO = T2.CNTR_NO
           AND T5.CNTR_SN = T2.CNTR_SN
           AND T5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_STLM_REL T6 /* 계약결제관계 */
            ON T6.DTL_CNTR_NO = T2.CNTR_NO
           AND T6.DTL_CNTR_SN = T2.CNTR_SN
           AND T6.DTA_DL_YN = 'N'
           AND T6.VL_END_DTM = '99991231235959'
           AND T6.DP_TP_CD IN ('0101', '0102', '0203', '0401') /* 입금유형코드=개별수납(가상계좌)(0101),계좌자동이체(0102),카드자동이체(0203),지로(0401) */
           AND T6.RVE_DV_CD IN ('03','04','05') /* 수납구분코드 - 03:월납입액(할부금, 렌탈료), 04:멤버십회비, 05:정기배송회비*/
          LEFT OUTER JOIN TB_SSCT_CNTR_STLM_BAS T7 /* 계약결제기본 */
            ON T7.CNTR_STLM_ID = T6.CNTR_STLM_ID
           AND T7.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_RVCL_ITG_BIL_OJ_BAS T8 /* 계좌이체 */
            ON T8.SUBOD_CNTR_NO = T2.CNTR_NO
           AND T8.SUBOD_CNTR_SN = T2.CNTR_SN
           AND T8.FNT_DV_CD = '01' /* 이체구분코드=계좌이체(01) */
           AND T8.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_RVCL_ITG_BIL_OJ_BAS T9	/* 카드이체 */
            ON T9.SUBOD_CNTR_NO = T2.CNTR_NO
           AND T9.SUBOD_CNTR_SN = T2.CNTR_SN
           AND T9.FNT_DV_CD = '02' /* 이체구분코드 카드이체(02) */
           AND T9.DTA_DL_YN = 'N'
          LEFT OUTER JOIN LATERAL /* 설치주소지정보 */
             ( SELECT X1.DTL_CNTR_NO /* 계약번호 */
                    , X1.DTL_CNTR_SN /* 계약일련번호 */
                    , NVL(X3.NEW_ADR_ZIP, X3.OLD_ADR_ZIP) AS ADR_ZIP /* 우편번호 */
                    , CASE WHEN X2.ADR_DV_CD = '1' THEN X3.RNADR /* 도로명 */
                           WHEN X2.ADR_DV_CD = '2' THEN X3.LTN_ADR /* 지번 */
                      END AS RNADR /* 주소 */
                    , CASE WHEN X2.ADR_DV_CD = '1' THEN X3.RDADR /* 도로명 */
                           WHEN X2.ADR_DV_CD = '2' THEN X3.LTN_DTL_ADR /* 지번 */
                      END AS RDADR /* 상세주소 */
                    , X2.CRAL_LOCARA_TNO /* 휴대지역전화번호 */
                    , X2.MEXNO_ENCR /* 휴대전화국번호암호화 */
                    , X2.CRAL_IDV_TNO /* 휴대개별전화번호 */
                    , X2.LOCARA_TNO /* 지역전화번호 */
                    , X2.EXNO_ENCR /* 전화국번호암호화 */
                    , X2.IDV_TNO /* 개별전화번호 */
                    , X2.RCGVP_KNM /* 수령자한글명 */
                 FROM TB_SSCT_CNTR_ADR_REL X1
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS X2
                   ON X2.CNTR_ADRPC_ID = X1.CNTR_ADRPC_ID
                  AND X2.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_GBCO_ADR_BAS X3
                   ON X3.ADR_ID = X2.ADR_ID
                  AND X3.DTA_DL_YN = 'N'
                WHERE 1 = 1
                  AND X1.DTA_DL_YN = 'N'
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN X1.VL_STRT_DTM AND X1.VL_END_DTM
                  AND X1.ADRPC_TP_CD = '3' /* 주소유형. 계약(1),설치(3) */
                  AND X1.DTL_CNTR_NO = T2.CNTR_NO
                  AND X1.DTL_CNTR_SN = T2.CNTR_SN
             ) T10 /* 설치자주소 */
            ON T10.DTL_CNTR_NO = T2.CNTR_NO
           AND T10.DTL_CNTR_SN = T2.CNTR_SN
          LEFT OUTER JOIN LATERAL
             ( SELECT X1.CST_NO /* 고객번호 */
                    , X1.CST_KNM /* 고객한글명 */
                    , NVL(X2.NEW_ADR_ZIP, X2.OLD_ADR_ZIP) AS ADR_ZIP /* 우편번호 */
                    , NVL(X2.RNADR, X2.LTN_ADR) AS RNADR /* 도로명주소 */
                    , NVL(X2.RDADR, X2.LTN_DTL_ADR) AS RDADR /* 도로명주소상세 */
                    , X1.CRAL_LOCARA_TNO /* 휴대지역전화번호 */
                    , X1.MEXNO_ENCR /* 휴대전화국번암호화 */
                    , X1.CRAL_IDV_TNO /* 휴대개별전화번호 */
                    , X3.LOCARA_TNO /* 지역전화번호 */
                    , X3.EXNO_ENCR /* 전화국번암호화 */
                    , X3.IDV_TNO /* 개별전화번호 */
                 FROM TB_CUBS_CST_BAS X1 /* 고객기본 */
                 LEFT OUTER JOIN TB_GBCO_ADR_BAS X2 /* 주소기본 */
                   ON X2.ADR_ID = X1.ADR_ID
                  AND X2.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN LATERAL
                    ( SELECT LOCARA_TNO
                           , EXNO_ENCR
                           , IDV_TNO
                           , CST_CTPLC_OJ_REFK_VAL AS CST_NO
                        FROM TB_CUBS_CST_CTPLC_BAS /* 고객연락처기본 */
                       WHERE CST_CTPLC_OJ_REFK_VAL = X1.CST_NO
                         AND CTPLC_TP_CD = '04' /* 연락처유형코드=자택전화(04) */
                         AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN HIST_STRT_DTM AND HIST_END_DTM
                         AND DTA_DL_YN = 'N'
                         AND FST_RGST_DTM = ( SELECT MAX(FST_RGST_DTM)
                                                FROM TB_CUBS_CST_CTPLC_BAS
                                               WHERE CST_CTPLC_OJ_REFK_VAL = X1.CST_NO
                                                 AND CTPLC_TP_CD = '04'
                                                 AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN HIST_STRT_DTM AND HIST_END_DTM
                                                 AND DTA_DL_YN = 'N'
                                            )
                    ) X3
                   ON X3.CST_NO = X1.CST_NO
                WHERE 1 = 1
                  AND X1.CST_NO = T1.CNTR_CST_NO
                  AND X1.DTA_DL_YN = 'N'
             ) T11 /* 계약자 정보 */
            ON T11.CST_NO = T1.CNTR_CST_NO
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
           AND T2.SELL_TP_CD = #{sellTpCd}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
           AND T2.CNTR_NO = #{cntrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
           AND T2.CNTR_SN = #{cntrSn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrCstNo)'>
           AND T1.CNTR_CST_NO = #{cntrCstNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rcpDtFrom)'>
           AND T1.CNTR_CNFM_DTM <![CDATA[ >= ]]> #{rcpDtFrom} || '000000'
        </if>
        <if test='@MybatisUtils@isNotEmpty(rcpDtTo)'>
           AND T1.CNTR_CNFM_DTM <![CDATA[ <= ]]> #{rcpDtTo} || '235959'
        </if>
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND T1.SELL_PRTNR_NO = #{prtnrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(emadr)'>
           AND T5.EMADR = #{emadr}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cardAccNo)'>
           AND ( T7.ACNO_ENCR = #{cardAccNo} OR T7.CRCDNO_ENCR = #{cardAccNo} )
        </if>
        <if test='@MybatisUtils@isNotEmpty(ogCd)'>
           AND EXISTS ( SELECT PRTNR_NO
                          FROM TB_OGBS_MM_PRTNR_IZ
                         WHERE BASE_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                           AND DTA_DL_YN = 'N'
                           AND PRTNR_NO = T1.SELL_PRTNR_NO
                           AND OG_CD = #{ogCd}
                      )
        </if>
        <if test='@MybatisUtils@equals(prcDvCd, "2")'>
         ORDER BY RPRS_CNTR_NO DESC, IS_BNDL_MAST DESC, T2.CNTR_NO||T2.CNTR_SN DESC
        </if>
        <if test='!@MybatisUtils@equals(prcDvCd, "2")'>
         ORDER BY T2.SELL_TP_CD
        </if>
    </select>

    <select id="selectPlannerChanges" resultType="com.kyowon.sms.wells.web.contract.changeorder.dvo.WctbCustomerBaseBulkChangeDvo">
        /* 고객기준 일괄변경 대상 조회(플래너변경) */
        SELECT T3.PRTNR_KNM /* [이름] 파트너한글명 */
             , T2.SELL_TP_CD /* 판매유형코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T2.SELL_TP_CD) AS SELL_TP_NM /* [업무구분] 판매유형명 */
             , T2.CNTR_NO /* [계약번호] */
             , T2.CNTR_SN /* [계약일련번호] 계약일련번호 */
             , T4.CST_KNM /* [고객명] 고객한글명 */
             , T1.CNTR_CNFM_DTM /* [접수일자] 계약확정일시 */
             , T1.CNTR_CST_NO /* [고객번호] 계약고객번호 */
             , ( SELECT MIN(SL_RCOG_DT) /* 매출인식일자 */
                   FROM TB_CBCL_WELLS_SL_MM_CL_IZ /* WELLS매출월마감내역 */
                  WHERE CNTR_NO = T2.CNTR_NO
                    AND CNTR_SN = T2.CNTR_SN
                    AND DTA_DL_YN = 'N'
               ) AS SL_DT /* [매출일자] 매출인식일자 */
             , T1.SELL_PRTNR_NO /* 판매파트너번호 */
             , T5.OG_CD /* [계약마스터-조직코드] 조직코드 */
             , T5.DGR3_LEVL_DG_PRTNR_NO /* [계약마스터-지점장코드] 3차레벨대표파트너번호 */
             , T5.DGR2_LEVL_DG_PRTNR_NO /* [계약마스터-지역단장코드] 2차레벨대표파트너번호 */
             , T5.DGR1_LEVL_DG_PRTNR_NO /* [계약마스터-총괄단장코드] 1차레벨대표파트너번호 */
             , T5.DGR1_LEVL_OG_CD /* [계약마스터-총괄단코드] 1차레벨조직코드 */
             , T6.OG_CD AS CUR_OG_CD /* [대리인마스터-조직코드] 조직코드 */
             , T6.DGR3_LEVL_DG_PRTNR_NO AS CUR_DGR3_LEVL_DG_PRTNR_NO /* [대리인마스터-지점장코드] 3차레벨대표파트너번호 */
             , T6.DGR2_LEVL_DG_PRTNR_NO AS CUR_DGR2_LEVL_DG_PRTNR_NO /* [대리인마스터-지역단장코드] 2차레벨대표파트너번호 */
             , T6.DGR1_LEVL_DG_PRTNR_NO AS CUR_DGR1_LEVL_DG_PRTNR_NO /* [대리인마스터-총괄단장코드] 1차레벨대표파트너번호 */
             , T6.DGR1_LEVL_OG_CD AS CUR_DGR1_LEVL_OG_CD /* [대리인마스터-총괄단코드] 1차레벨조직코드 */
             , '' AS CH_EP_NO /* 변경사번 */
          FROM TB_SSCT_CNTR_BAS T1 /* 계약기본 */
         INNER JOIN TB_SSCT_CNTR_DTL T2 /* 계약상세 */
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
           AND T2.SELL_TP_CD IN ('1','2','3','6')	/* 판매유형코드. 일시불(1),렌탈(2),멤버십(3),정기배송(6) */
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T3 /* 월파트너내역 */
            ON T3.BASE_YM = SUBSTR(T1.CNTR_CNFM_DTM, 1, 6)
           AND T3.OG_TP_CD = T1.SELL_OG_TP_CD
           AND T3.PRTNR_NO = T1.SELL_PRTNR_NO
           AND T3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS T4 /* 고객기본 */
            ON T4.CST_NO = T1.CNTR_CST_NO
           AND T4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN LATERAL
             ( SELECT X2.PRTNR_NO
                    , X2.PRTNR_KNM
                    , X2.OG_TP_CD
                    , X1.OG_CD /* 조직코드 */
                    , X1.OG_NM /* 조직명 */
                    , DGR1_LEVL_OG_CD /* 1차레벨조직코드 */
                    , DGR1_LEVL_OG_NM /* 1차레벨조직명 */
                    , DGR1_LEVL_DG_PRTNR_NO /* 1차레벨대표파트너번호 */
                    , DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
                    , DGR2_LEVL_OG_CD /* 2차레벨조직코드 */
                    , DGR2_LEVL_OG_NM /* 2차레벨조직명 */
                    , DGR2_LEVL_DG_PRTNR_NO /* 2차레벨대표파트너번호 */
                    , DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
                    , DGR3_LEVL_OG_CD /* 3차레벨조직코드 */
                    , DGR3_LEVL_OG_NM /* 3차레벨조직명 */
                    , DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
                    , DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
                 FROM TB_OGBS_MM_PRTNR_IZ X2
                 LEFT OUTER JOIN TB_OGBS_MM_OG_IZ X1
                   ON X1.BASE_YM = X2.BASE_YM
                  AND X1.DTA_DL_YN = 'N'
                  AND X1.OG_ID = X2.OG_ID
                WHERE 1 = 1
                  AND X2.BASE_YM = SUBSTR(T1.CNTR_CNFM_DTM, 1, 6)
                  AND X2.DTA_DL_YN = 'N'
                  AND X1.OG_ID = X1.OG_ID
             ) T5 /* 계약시점 파트너,조직정보 */
            ON T5.PRTNR_NO = T1.SELL_PRTNR_NO
           AND T5.OG_TP_CD = T1.SELL_OG_TP_CD
          LEFT OUTER JOIN LATERAL
             ( SELECT X2.PRTNR_NO
                    , X2.PRTNR_KNM
                    , X2.OG_TP_CD
                    , X1.OG_CD /* 조직코드 */
                    , X1.OG_NM /* 조직명 */
                    , DGR1_LEVL_OG_CD /* 1차레벨조직코드 */
                    , DGR1_LEVL_OG_NM /* 1차레벨조직명 */
                    , DGR1_LEVL_DG_PRTNR_NO /* 1차레벨대표파트너번호 */
                    , DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
                    , DGR2_LEVL_OG_CD /* 2차레벨조직코드 */
                    , DGR2_LEVL_OG_NM /* 2차레벨조직명 */
                    , DGR2_LEVL_DG_PRTNR_NO /* 2차레벨대표파트너번호 */
                    , DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
                    , DGR3_LEVL_OG_CD /* 3차레벨조직코드 */
                    , DGR3_LEVL_OG_NM /* 3차레벨조직명 */
                    , DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
                    , DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
                 FROM TB_OGBS_MM_PRTNR_IZ X2
                 LEFT OUTER JOIN TB_OGBS_MM_OG_IZ X1
                   ON X1.BASE_YM = X2.BASE_YM
                  AND X1.DTA_DL_YN = 'N'
                  AND X1.OG_ID = X2.OG_ID
                WHERE 1 = 1
                  AND X2.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                  AND X2.DTA_DL_YN = 'N'
                  AND X1.OG_ID = X1.OG_ID
             ) T6 /* 현시점 파트너,조직정보 */
            ON T6.PRTNR_NO = T1.SELL_PRTNR_NO
           AND T6.OG_TP_CD = T1.SELL_OG_TP_CD
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
           AND T2.SELL_TP_CD = #{sellTpCd}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
           AND T2.CNTR_NO = #{cntrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
           AND T2.CNTR_SN = #{cntrSn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrCstNo)'>
           AND T1.CNTR_CST_NO = #{cntrCstNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rcpDtFrom)'>
           AND T1.CNTR_CNFM_DTM <![CDATA[ >= ]]> #{rcpDtFrom} || '000000'
        </if>
        <if test='@MybatisUtils@isNotEmpty(rcpDtTo)'>
           AND T1.CNTR_CNFM_DTM <![CDATA[ <= ]]> #{rcpDtTo} || '235959'
        </if>
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND T1.SELL_PRTNR_NO = #{prtnrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(emadr)'>
           AND T5.EMADR = #{emadr}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cardAccNo)'>
           AND ( T7.ACNO_ENCR = #{cardAccNo} OR T7.CRCDNO_ENCR = #{cardAccNo} )
        </if>
        <if test='@MybatisUtils@isNotEmpty(ogCd)'>
           AND EXISTS ( SELECT PRTNR_NO
                          FROM TB_OGBS_MM_PRTNR_IZ
                         WHERE BASE_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                           AND DTA_DL_YN = 'N'
                           AND PRTNR_NO = T1.SELL_PRTNR_NO
                           AND OG_CD = #{ogCd}
                      )
        </if>
    </select>

    <select id="selectContractAddressId" resultType="java.lang.String">
        SELECT A01.CNTR_ADRPC_ID /* 계약주소지ID*/
          FROM TB_SSCT_CNTR_ADR_REL A01 /* 계약주소관계*/
         WHERE 1 = 1
           AND A01.ADRPC_TP_CD = '3' /* 주소지유형코드 - 3:설치주소*/
           AND A01.DTL_CNTR_NO = #{cntrNo}
           AND A01.DTL_CNTR_SN = #{cntrSn}
           AND A01.VL_END_DTM = '99991231235959'
           AND A01.DTA_DL_YN = 'N'
           AND ROWNUM = 1
    </select>

    <select id="selectDateTime" resultType="com.kyowon.sms.wells.web.contract.changeorder.dvo.WctbCustomerBaseBulkChangeDvo">
        /* 데이터의 INSERT/UPDATE/유효시작일시/유효종료일시를 일관되게 맞추기 위해, 미리 조회해온다. */
        SELECT TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS FST_RGST_DTM
             , #{session.userId} AS FST_RGST_USR_ID
             , #{session.pageId} AS FST_RGST_PRG_ID
             , #{session.ogId} AS FST_RGST_DEPT_ID
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS FNL_MDFC_DTM
             , #{session.userId} AS FNL_MDFC_USR_ID
             , #{session.pageId} AS FNL_MDFC_PRG_ID
             , #{session.ogId} AS FNL_MDFC_DEPT_ID
          FROM DUAL
    </select>

    <select id="selectSellInflwChannelDetailCd" resultType="java.lang.String">
        SELECT SELL_INFLW_CHNL_DTL_CD /* 판매유입채널상세코드*/
          FROM TB_OGBS_MM_PRTNR_IZ /* 월파트너내역*/
         WHERE BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
           AND PRTNR_NO = #{prtnrNo}
           AND OG_TP_CD = #{ogTpCd}
           AND DTA_DL_YN = 'N'
    </select>

    <select id="selectSellOgTpCd" resultType="java.lang.String">
        SELECT SELL_OG_TP_CD /* 판매조직유형코드 */
          FROM TB_SSCT_CNTR_BAS /* 계약기본 */
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND DTA_DL_YN = 'N'
    </select>


    <select id="selectCrcdBeforeChange" resultType="com.kyowon.sms.wells.web.contract.changeorder.dvo.WctbCustomerBaseBulkChangeDvo">
        SELECT CNTR_STLM_ID     /* 계약결제ID*/
             , DP_TP_CD         /* 입금유형코드*/
             , STLM_HD_DV_CD    /* 결제보류구분코드*/
          FROM TB_SSCT_CNTR_STLM_REL /* 계약결제관계*/
         WHERE 1 = 1
           AND DTL_CNTR_NO  = #{cntrNo}
           AND DTL_CNTR_SN  = #{cntrSn}
           AND VL_END_DTM   = '99991231235959'
           AND DTA_DL_YN    = 'N'
           AND RVE_DV_CD IN ('03', '04', '05') /* 수납구분코드 03:월납입액(할부금, 렌탈료), 04:멤버십회비, 05:정기배송회비*/
           AND CNTR_STLM_ID = #{cntrStlmId}
    </select>

    <insert id="insertContractChangeRcpBase">
        <selectKey keyProperty="item.cntrChRcpId" resultType="java.lang.String" order="BEFORE">
            SELECT LPAD(NVL(MAX(TO_NUMBER(CNTR_CH_RCP_ID)), 0) +1, 15, '0')
              FROM TB_SSCT_CNTR_CH_RCP_BAS
        </selectKey>
        INSERT INTO TB_SSCT_CNTR_CH_RCP_BAS (  /* 계약변경접수기본 */
               CNTR_CH_RCP_ID       /* 계약변경접수ID */
             , CNTR_CH_RCP_DTM      /* 계약변경접수일시 */
             , CNTR_CH_TP_CD        /* 계약변경유형코드 */
             , CH_RQR_DV_CD         /* 변경요청자구분코드 */
             , CH_RQR_NM            /* 변경요청자명 */
             , CST_NO               /* 고객번호 */
             , CNTR_CH_AK_CN        /* 계약변경요청내용 */
             , CNTR_CH_PRGS_STAT_CD /* 계약변경진행상태코드 */
             , CNTR_CH_PRGS_MO_CN   /* 계약변경진행메모내용 */
             , CH_RCST_DV_CD        /* 변경접수자구분코드 */
             , CH_RCP_USR_ID        /* 변경접수사용자ID */
             , APR_DTM              /* 승인일시 */
             , APR_USR_ID           /* 승인사용자ID */
             , CNTR_CH_FSH_DTM      /* 계약변경완료일시 */
             , BIZ_TF_ID            /* 업무이관ID */
             , DTA_DL_YN            /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               #{item.cntrChRcpId}
             , #{item.cntrChRcpDtm}
             , #{item.cntrChTpCd}
             , #{item.chRqrDvCd}
             , #{item.chRqrNm}
             , #{item.cstNo}
             , #{item.cntrChAkCn}
             , #{item.cntrChPrgsStatCd}
             , #{item.cntrChPrgsMoCn}
             , #{item.chRcstDvCd}
             , #{item.chRcpUsrId}
             , #{item.aprDtm}
             , #{item.aprUsrId}
             , #{item.cntrChFshDtm}
             , #{item.bizTfId}
             , #{item.dtaDlYn}
             , #{item.fstRgstDtm}       /* 최초등록일시 */
             , #{item.fstRgstUsrId}     /* 최초등록사용자ID */
             , #{item.fstRgstPrgId}     /* 최초등록프로그램ID */
             , #{item.fstRgstDeptId}    /* 최초등록부서ID */
             , #{item.fnlMdfcDtm}       /* 최종수정일시 */
             , #{item.fnlMdfcUsrId}     /* 최종수정사용자ID */
             , #{item.fnlMdfcPrgId}     /* 최종수정프로그램ID */
             , #{item.fnlMdfcDeptId}    /* 최종수정부서ID */
            )
    </insert>

    <insert id="insertContractChangeRcpBaseHist">
        INSERT INTO TB_SSCT_CNTR_CH_RCCH_HIST (  /* 계약변경접수변경이력 */
               CNTR_CH_RCP_ID       /* 계약변경접수ID */
             , HIST_STRT_DTM        /* 이력시작일시 */
             , HIST_END_DTM         /* 이력종료일시 */
             , CNTR_CH_RCP_DTM      /* 계약변경접수일시 */
             , CNTR_CH_TP_CD        /* 계약변경유형코드 */
             , CH_RQR_DV_CD         /* 변경요청자구분코드 */
             , CH_RQR_NM            /* 변경요청자명 */
             , CST_NO               /* 고객번호 */
             , CNTR_CH_AK_CN        /* 계약변경요청내용 */
             , CNTR_CH_PRGS_STAT_CD /* 계약변경진행상태코드 */
             , CNTR_CH_PRGS_MO_CN   /* 계약변경진행메모내용 */
             , CH_RCST_DV_CD        /* 변경접수자구분코드 */
             , CH_RCP_USR_ID        /* 변경접수사용자ID */
             , APR_DTM              /* 승인일시 */
             , APR_USR_ID           /* 승인사용자ID */
             , CNTR_CH_FSH_DTM      /* 계약변경완료일시 */
             , BIZ_TF_ID            /* 업무이관ID */
             , DTA_DL_YN            /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />
            )

        SELECT CNTR_CH_RCP_ID       /* 계약변경접수ID */
             , #{histStrtDtm} AS HIST_STRT_DTM /* 이력시작일시 */
             , #{histEndDtm} AS HIST_END_DTM /* 이력종료일시 */
             , CNTR_CH_RCP_DTM      /* 계약변경접수일시 */
             , CNTR_CH_TP_CD        /* 계약변경유형코드 */
             , CH_RQR_DV_CD         /* 변경요청자구분코드 */
             , CH_RQR_NM            /* 변경요청자명 */
             , CST_NO               /* 고객번호 */
             , CNTR_CH_AK_CN        /* 계약변경요청내용 */
             , CNTR_CH_PRGS_STAT_CD /* 계약변경진행상태코드 */
             , CNTR_CH_PRGS_MO_CN   /* 계약변경진행메모내용 */
             , CH_RCST_DV_CD        /* 변경접수자구분코드 */
             , CH_RCP_USR_ID        /* 변경접수사용자ID */
             , APR_DTM              /* 승인일시 */
             , APR_USR_ID           /* 승인사용자ID */
             , CNTR_CH_FSH_DTM      /* 계약변경완료일시 */
             , BIZ_TF_ID            /* 업무이관ID */
             , DTA_DL_YN            /* 데이터삭제여부 */
             , FST_RGST_DTM         /* 최초등록일시 */
             , FST_RGST_USR_ID      /* 최초등록사용자ID */
             , FST_RGST_PRG_ID      /* 최초등록프로그램ID */
             , FST_RGST_DEPT_ID     /* 최초등록부서ID */
             , FNL_MDFC_DTM         /* 최종수정일시 */
             , FNL_MDFC_USR_ID      /* 최종수정사용자ID */
             , FNL_MDFC_PRG_ID      /* 최종수정프로그램ID */
             , FNL_MDFC_DEPT_ID     /* 최종수정부서ID */
          FROM TB_SSCT_CNTR_CH_RCP_BAS
         WHERE 1=1
           AND CNTR_CH_RCP_ID = #{cntrChRcpId}
    </insert>

    <insert id="insertContractChangeRcpDtl">
        <selectKey keyProperty="item.cntrChSn" resultType="Integer" order="BEFORE">
            SELECT LPAD(NVL(MAX(TO_NUMBER(CNTR_CH_SN)), 0) +1, 15, '0')
              FROM TB_SSCT_CNTR_CH_RCP_DTL
             WHERE CNTR_CH_RCP_ID = #{item.cntrChRcpId}
        </selectKey>

        INSERT INTO TB_SSCT_CNTR_CH_RCP_DTL (  /* 계약변경접수상세 */
               CNTR_CH_RCP_ID     /* 계약변경접수ID */
             , CNTR_CH_SN         /* 계약변경일련번호 */
             , CNTR_UNIT_TP_CD    /* 계약단위유형코드 */
             , CNTR_NO            /* 계약번호 */
             , DTL_CNTR_NO        /* 상세계약번호 */
             , DTL_CNTR_SN        /* 상세계약일련번호 */
             , CNTR_CH_RSON_DV_CD /* 계약변경사유구분코드 */
             , CNTR_CH_RSON_CD    /* 계약변경사유코드 */
             , CNTR_CH_ATC_DV_CD  /* 계약변경항목구분코드 */
             , CH_APY_STRTDT      /* 변경적용시작일자 */
             , CH_APY_ENDDT       /* 변경적용종료일자 */
             , CH_PD_CD           /* 변경상품코드 */
             , CH_QTY             /* 변경수량 */
             , CH_AMT             /* 변경금액 */
             , CH_PTRM_UNIT_CD    /* 변경기간단위코드 */
             , CH_PTRM_N          /* 변경기간수 */
             , CNTR_CH_AK_CN      /* 계약변경요청내용 */
             , CNTR_ADRPC_ID      /* 계약주소지ID */
             , CNTR_STLM_ID       /* 계약결제ID */
             , BFCH_CN            /* 변경전내용 */
             , PROCS_YN           /* 처리여부 */
             , PROCS_DUEDT        /* 처리예정일자 */
             , PROCS_FSH_DTM      /* 처리완료일시 */
             , DTA_DL_YN          /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               #{item.cntrChRcpId}
             , #{item.cntrChSn}
             , #{item.cntrUnitTpCd}
             , #{item.cntrNo}
             , #{item.dtlCntrNo}
             , #{item.dtlCntrSn}
             , #{item.cntrChRsonDvCd}
             , #{item.cntrChRsonCd}
             , #{item.cntrChAtcDvCd}
             , #{item.chApyStrtdt}
             , #{item.chApyEnddt}
             , #{item.chPdCd}
             , #{item.chQty}
             , #{item.chAmt}
             , #{item.chPtrmUnitCd}
             , #{item.chPtrmN}
             , #{item.cntrChAkCn}
             , #{item.cntrAdrpcId}
             , #{item.cntrStlmId}
             , #{item.bfchCn}
             , #{item.procsYn}
             , #{item.procsDuedt}
             , #{item.procsFshDtm}
             , #{item.dtaDlYn}
             , #{item.fstRgstDtm}
             , #{item.fstRgstUsrId}
             , #{item.fstRgstPrgId}
             , #{item.fstRgstDeptId}
             , #{item.fnlMdfcDtm}
             , #{item.fnlMdfcUsrId}
             , #{item.fnlMdfcPrgId}
             , #{item.fnlMdfcDeptId} )
    </insert>

    <insert id="insertContractChangeRcpDtlHist">
        INSERT INTO TB_SSCT_CNTR_CH_RCP_DCH_HIST (  /* 계약변경접수상세변경이력 */
               CNTR_CH_RCP_ID     /* 계약변경접수ID */
             , HIST_STRT_DTM      /* 이력시작일시 */
             , CNTR_CH_SN         /* 계약변경일련번호 */
             , HIST_END_DTM       /* 이력종료일시 */
             , CNTR_UNIT_TP_CD    /* 계약단위유형코드 */
             , CNTR_NO            /* 계약번호 */
             , DTL_CNTR_NO        /* 상세계약번호 */
             , DTL_CNTR_SN        /* 상세계약일련번호 */
             , CNTR_CH_RSON_DV_CD /* 계약변경사유구분코드 */
             , CNTR_CH_RSON_CD    /* 계약변경사유코드 */
             , CNTR_CH_ATC_DV_CD  /* 계약변경항목구분코드 */
             , CH_APY_STRTDT      /* 변경적용시작일자 */
             , CH_APY_ENDDT       /* 변경적용종료일자 */
             , CH_PD_CD           /* 변경상품코드 */
             , CH_QTY             /* 변경수량 */
             , CH_AMT             /* 변경금액 */
             , CH_PTRM_UNIT_CD    /* 변경기간단위코드 */
             , CH_PTRM_N          /* 변경기간수 */
             , CNTR_CH_AK_CN      /* 계약변경요청내용 */
             , CNTR_ADRPC_ID      /* 계약주소지ID */
             , CNTR_STLM_ID       /* 계약결제ID */
             , PROCS_YN           /* 처리여부 */
             , BFCH_CN            /* 변경전내용 */
             , PROCS_DUEDT        /* 처리예정일자 */
             , PROCS_FSH_DTM      /* 처리완료일시 */
             , DTA_DL_YN          /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />
        )
        SELECT CNTR_CH_RCP_ID                        /* 계약변경접수ID */
             , #{histStrtDtm} AS HIST_STRT_DTM       /* 이력시작일시 */
             , CNTR_CH_SN                            /* 계약변경일련번호 */
             , #{histEndDtm} AS HIST_END_DTM         /* 이력종료일시 */
             , CNTR_UNIT_TP_CD    /* 계약단위유형코드 */
             , CNTR_NO            /* 계약번호 */
             , DTL_CNTR_NO        /* 상세계약번호 */
             , DTL_CNTR_SN        /* 상세계약일련번호 */
             , CNTR_CH_RSON_DV_CD /* 계약변경사유구분코드 */
             , CNTR_CH_RSON_CD    /* 계약변경사유코드 */
             , CNTR_CH_ATC_DV_CD  /* 계약변경항목구분코드 */
             , CH_APY_STRTDT      /* 변경적용시작일자 */
             , CH_APY_ENDDT       /* 변경적용종료일자 */
             , CH_PD_CD           /* 변경상품코드 */
             , CH_QTY             /* 변경수량 */
             , CH_AMT             /* 변경금액 */
             , CH_PTRM_UNIT_CD    /* 변경기간단위코드 */
             , CH_PTRM_N          /* 변경기간수 */
             , CNTR_CH_AK_CN      /* 계약변경요청내용 */
             , CNTR_ADRPC_ID      /* 계약주소지ID */
             , CNTR_STLM_ID       /* 계약결제ID */
             , PROCS_YN           /* 처리여부 */
             , BFCH_CN            /* 변경전내용 */
             , PROCS_DUEDT        /* 처리예정일자 */
             , PROCS_FSH_DTM      /* 처리완료일시 */
             , DTA_DL_YN          /* 데이터삭제여부 */
             , FST_RGST_DTM       /* 최초등록일시 */
             , FST_RGST_USR_ID    /* 최초등록사용자ID */
             , FST_RGST_PRG_ID    /* 최초등록프로그램ID */
             , FST_RGST_DEPT_ID   /* 최초등록부서ID */
             , FNL_MDFC_DTM       /* 최종수정일시 */
             , FNL_MDFC_USR_ID    /* 최종수정사용자ID */
             , FNL_MDFC_PRG_ID    /* 최종수정프로그램ID */
             , FNL_MDFC_DEPT_ID   /* 최종수정부서ID */
          FROM TB_SSCT_CNTR_CH_RCP_DTL
         WHERE 1=1
           AND CNTR_CH_RCP_ID = #{cntrChRcpId}
           AND CNTR_CH_SN = #{cntrChSn}
    </insert>

    <insert id="insertContractDetailHist">
        INSERT INTO TB_SSCT_CNTR_DCH_HIST (  /* 계약상세변경이력 */
               CNTR_NO             /* 계약번호 */
             , HIST_STRT_DTM       /* 이력시작일시 */
             , CNTR_SN             /* 계약일련번호 */
             , HIST_END_DTM        /* 이력종료일시 */
             , BASE_PD_CD          /* 기준상품코드 */
             , HGR_PD_CD           /* 상위상품코드 */
             , PD_QTY              /* 상품수량 */
             , SELL_TP_CD
             , SELL_TP_DTL_CD      /* 판매유형상세코드 */
             , CNTR_DTL_STAT_CD    /* 계약상세상태코드 */
             , CNTR_PTRM_UNIT_CD   /* 계약기간단위코드 */
             , CNTR_PTRM           /* 계약기간 */
             , CNTR_PD_STRTDT      /* 계약상품시작일자 */
             , CNTR_PD_ENDDT       /* 계약상품종료일자 */
             , STPL_PTRM_UNIT_CD   /* 약정기간단위코드 */
             , STPL_PTRM           /* 약정기간 */
             , SV_PTRM_UNIT_CD     /* 서비스기간단위코드 */
             , SV_PRD              /* 서비스주기 */
             , CNTRW_TP_CD         /* 계약서유형코드 */
             , BLG_CRP_CD          /* 소속법인코드 */
             , RVE_CRP_CD          /* 수납법인코드 */
             , CO_CD               /* 회사코드 */
             , BOO_SELL_TP_CD
             , PD_GD_CD            /* 상품등급코드 */
             , PD_HCLSF_ID         /* 상품대분류ID */
             , PD_MCLSF_ID         /* 상품중분류ID */
             , PD_LCLSF_ID         /* 상품소분류ID */
             , PD_DCLSF_ID         /* 상품세분류ID */
             , SELL_DSC_DV_CD      /* 판매할인구분코드 */
             , SELL_DSCR_CD        /* 판매할인율코드 */
             , SELL_DSC_CTR_AMT    /* 판매할인조정금액 */
             , SELL_DSC_TP_CD      /* 판매할인유형코드 */
             , STLM_TP_CD          /* 결제유형코드 */
             , CRNCY_DV_CD         /* 통화구분코드 */
             , APY_EXCR            /* 적용환율 */
             , PD_BASE_AMT         /* 상품기준금액 */
             , SELL_AMT            /* 판매금액 */
             , DSC_AMT             /* 할인금액 */
             , FNL_AMT             /* 최종금액 */
             , VAT                 /* 부가가치세 */
             , CNTR_AMT            /* 계약금액 */
             , CNTRAM_DSC_AMT      /* 계약금할인금액 */
             , ISTM_MCN            /* 할부개월수 */
             , ISTM_PCAM_AMT       /* 할부원금금액 */
             , ISTM_INT_AMT        /* 할부이자금액 */
             , MM_ISTM_AMT         /* 월할부금액 */
             , CRP_UC_AMT          /* 법인미수금액 */
             , SELL_FEE            /* 판매수수료 */
             , CNTR_TAM            /* 계약총액 */
             , RENTAL_PTRM2        /* 렌탈기간2 */
             , RENTAL_AMT2         /* 렌탈금액2 */
             , RENTAL_DSC_AMT2     /* 렌탈할인금액2 */
             , SV_AMT              /* 서비스금액 */
             , ACKMT_PERF_RT       /* 인정실적율 */
             , ACKMT_PERF_AMT      /* 인정실적금액 */
             , CVT_PERF_AMT        /* 환산실적금액 */
             , FEE_ACKMT_CT        /* 수수료인정건수 */
             , FEE_ACKMT_BASE_AMT  /* 수수료인정기준금액 */
             , FEE_FXAM_YN         /* 수수료정액여부 */
             , SPP_DUEDT           /* 배송예정일자 */
             , RESUB_YN            /* 재구독여부 */
             , RSTL_YN             /* 재약정여부 */
             , FRISU_YN            /* 무상여부 */
             , FRISU_DSB_TP_CD     /* 무상지급유형코드 */
             , TXINV_PBL_OJ_YN     /* 세금계산서발행대상여부 */
             , ALNCMP_CD           /* 제휴사코드 */
             , ALNCMP_CNTR_DRM_VAL /* 제휴사계약식별값 */
             , SMTPL_ID            /* 스마트플랜ID */
             , SMTPL_SN            /* 스마트플랜일련번호 */
             , CTT_OJ_ID           /* 컨택대상ID */
             , CTT_RS_CD           /* 컨택결과코드 */
             , CTT_PSIC_ID         /* 컨택담당자ID */
             , BF_ORD_NO           /* 이전주문번호 */
             , CNTR_CH_RCP_ID      /* 계약변경접수ID */
             , CNTR_CH_SN          /* 계약변경일련번호 */
             , CNTR_CH_DTL_AK_CN   /* 계약변경상세요청내용 */
             , DTA_DL_YN           /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        SELECT CNTR_NO             /* 계약번호 */
             , #{histStrtDtm} AS HIST_STRT_DTM       /* 이력시작일시 */
             , CNTR_SN             /* 계약일련번호 */
             , #{histEndDtm} AS HIST_END_DTM        /* 이력종료일시 */
             , BASE_PD_CD          /* 기준상품코드 */
             , HGR_PD_CD           /* 상위상품코드 */
             , PD_QTY              /* 상품수량 */
             , SELL_TP_CD          /* 판매유형코드 */
             , SELL_TP_DTL_CD      /* 판매유형상세코드 */
             , CNTR_DTL_STAT_CD    /* 계약상세상태코드 */
             , CNTR_PTRM_UNIT_CD   /* 계약기간단위코드 */
             , CNTR_PTRM           /* 계약기간 */
             , CNTR_PD_STRTDT      /* 계약상품시작일자 */
             , CNTR_PD_ENDDT       /* 계약상품종료일자 */
             , STPL_PTRM_UNIT_CD   /* 약정기간단위코드 */
             , STPL_PTRM           /* 약정기간 */
             , SV_PTRM_UNIT_CD     /* 서비스기간단위코드 */
             , SV_PRD              /* 서비스주기 */
             , CNTRW_TP_CD         /* 계약서유형코드 */
             , BLG_CRP_CD          /* 소속법인코드 */
             , RVE_CRP_CD          /* 수납법인코드 */
             , CO_CD               /* 회사코드 */
             , BOO_SELL_TP_CD      /* 예약판매유형코드 */
             , PD_GD_CD            /* 상품등급코드 */
             , PD_HCLSF_ID         /* 상품대분류ID */
             , PD_MCLSF_ID         /* 상품중분류ID */
             , PD_LCLSF_ID         /* 상품소분류ID */
             , PD_DCLSF_ID         /* 상품세분류ID */
             , SELL_DSC_DV_CD      /* 판매할인구분코드 */
             , SELL_DSCR_CD        /* 판매할인율코드 */
             , SELL_DSC_CTR_AMT    /* 판매할인조정금액 */
             , SELL_DSC_TP_CD      /* 판매할인유형코드 */
             , STLM_TP_CD          /* 결제유형코드 */
             , CRNCY_DV_CD         /* 통화구분코드 */
             , APY_EXCR            /* 적용환율 */
             , PD_BASE_AMT         /* 상품기준금액 */
             , SELL_AMT            /* 판매금액 */
             , DSC_AMT             /* 할인금액 */
             , FNL_AMT             /* 최종금액 */
             , VAT                 /* 부가가치세 */
             , CNTR_AMT            /* 계약금액 */
             , CNTRAM_DSC_AMT      /* 계약금할인금액 */
             , ISTM_MCN            /* 할부개월수 */
             , ISTM_PCAM_AMT       /* 할부원금금액 */
             , ISTM_INT_AMT        /* 할부이자금액 */
             , MM_ISTM_AMT         /* 월할부금액 */
             , CRP_UC_AMT          /* 법인미수금액 */
             , SELL_FEE            /* 판매수수료 */
             , CNTR_TAM            /* 계약총액 */
             , RENTAL_PTRM2        /* 렌탈기간2 */
             , RENTAL_AMT2         /* 렌탈금액2 */
             , RENTAL_DSC_AMT2     /* 렌탈할인금액2 */
             , SV_AMT              /* 서비스금액 */
             , ACKMT_PERF_RT       /* 인정실적율 */
             , ACKMT_PERF_AMT      /* 인정실적금액 */
             , CVT_PERF_AMT        /* 환산실적금액 */
             , FEE_ACKMT_CT        /* 수수료인정건수 */
             , FEE_ACKMT_BASE_AMT  /* 수수료인정기준금액 */
             , FEE_FXAM_YN         /* 수수료정액여부 */
             , SPP_DUEDT           /* 배송예정일자 */
             , RESUB_YN            /* 재구독여부 */
             , RSTL_YN             /* 재약정여부 */
             , FRISU_YN            /* 무상여부 */
             , FRISU_DSB_TP_CD     /* 무상지급유형코드 */
             , TXINV_PBL_OJ_YN     /* 세금계산서발행대상여부 */
             , ALNCMP_CD           /* 제휴사코드 */
             , ALNCMP_CNTR_DRM_VAL /* 제휴사계약식별값 */
             , SMTPL_ID            /* 스마트플랜ID */
             , SMTPL_SN            /* 스마트플랜일련번호 */
             , CTT_OJ_ID           /* 컨택대상ID */
             , CTT_RS_CD           /* 컨택결과코드 */
             , CTT_PSIC_ID         /* 컨택담당자ID */
             , BF_ORD_NO           /* 이전주문번호 */
             , CNTR_CH_RCP_ID      /* 계약변경접수ID */
             , CNTR_CH_SN          /* 계약변경일련번호 */
             , CNTR_CH_DTL_AK_CN   /* 계약변경상세요청내용 */
             , DTA_DL_YN           /* 데이터삭제여부 */
             , FST_RGST_DTM        /* 최초등록일시 */
             , FST_RGST_USR_ID     /* 최초등록사용자ID */
             , FST_RGST_PRG_ID     /* 최초등록프로그램ID */
             , FST_RGST_DEPT_ID    /* 최초등록부서ID */
             , FNL_MDFC_DTM        /* 최종수정일시 */
             , FNL_MDFC_USR_ID     /* 최종수정사용자ID */
             , FNL_MDFC_PRG_ID     /* 최종수정프로그램ID */
             , FNL_MDFC_DEPT_ID    /* 최종수정부서ID */
          FROM TB_SSCT_CNTR_DTL
         WHERE 1=1
           AND CNTR_NO = #{dtlCntrNo}
           AND CNTR_SN = #{dtlCntrSn}
    </insert>

    <insert id="insertContractBaseHist">
        INSERT INTO TB_SSCT_CNTR_CH_HIST (  /* 계약변경이력 */
               CNTR_NO                /* 계약번호 */
             , HIST_STRT_DTM          /* 이력시작일시 */
             , HIST_END_DTM           /* 이력종료일시 */
             , CNTR_CST_NO            /* 계약고객번호 */
             , COPN_DV_CD             /* 법인격구분코드 */
             , SELL_INFLW_CHNL_DTL_CD /* 판매유입채널상세코드 */
             , SELL_OG_TP_CD          /* 판매조직유형코드 */
             , SELL_PRTNR_NO          /* 판매파트너번호 */
             , CNTR_TP_CD             /* 계약유형코드 */
             , CNTR_NAT_CD            /* 계약국가코드 */
             , CNTR_PRGS_STAT_CD      /* 계약진행상태코드 */
             , CST_STLM_IN_MTH_CD     /* 고객결제입력방법코드 */
             , PRR_RCP_CNTR_YN        /* 사전접수계약여부 */
             , CNTR_TEMP_SAVE_DTM     /* 계약임시저장일시 */
             , CNTR_RCP_FSH_DTM       /* 계약접수완료일시 */
             , CNTR_STLM_FSH_DTM      /* 계약결제완료일시 */
             , CNTR_CNFM_APR_AK_DTM   /* 계약확정승인요청일시 */
             , CNTR_CNFM_APR_DTM      /* 계약확정승인일시 */
             , CNTR_CNFM_DTM          /* 계약확정일시 */
             , CNTR_CAN_DTM           /* 계약취소일시 */
             , CNTR_CAN_RSON_CD       /* 계약취소사유코드 */
             , CNTR_PRGS_STAT_MO_CN   /* 계약진행상태메모내용 */
             , DSB_GUR_TP_CD          /* 지급보증유형코드 */
             , CNTR_INFLW_PH_DV_CD    /* 계약유입경로구분코드 */
             , PSPC_CST_ID            /* 가망고객ID */
             , CNTR_CH_RCP_ID         /* 계약변경접수ID */
             , DCEVDN_DOC_ID          /* 증빙서류문서ID */
             , DTA_DL_YN              /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        SELECT CNTR_NO                /* 계약번호 */
             , #{histStrtDtm} AS HIST_STRT_DTM /* 이력시작일시 */
             , #{histEndDtm} AS HIST_END_DTM /* 이력종료일시 */
             , CNTR_CST_NO            /* 계약고객번호 */
             , COPN_DV_CD             /* 법인격구분코드 */
             , SELL_INFLW_CHNL_DTL_CD /* 판매유입채널상세코드 */
             , SELL_OG_TP_CD          /* 판매조직유형코드 */
             , SELL_PRTNR_NO          /* 판매파트너번호 */
             , CNTR_TP_CD             /* 계약유형코드 */
             , CNTR_NAT_CD            /* 계약국가코드 */
             , CNTR_PRGS_STAT_CD      /* 계약진행상태코드 */
             , CST_STLM_IN_MTH_CD     /* 고객결제입력방법코드 */
             , PRR_RCP_CNTR_YN        /* 사전접수계약여부 */
             , CNTR_TEMP_SAVE_DTM     /* 계약임시저장일시 */
             , CNTR_RCP_FSH_DTM       /* 계약접수완료일시 */
             , CNTR_STLM_FSH_DTM      /* 계약결제완료일시 */
             , CNTR_CNFM_APR_AK_DTM   /* 계약확정승인요청일시 */
             , CNTR_CNFM_APR_DTM      /* 계약확정승인일시 */
             , CNTR_CNFM_DTM          /* 계약확정일시 */
             , CNTR_CAN_DTM           /* 계약취소일시 */
             , CNTR_CAN_RSON_CD       /* 계약취소사유코드 */
             , CNTR_PRGS_STAT_MO_CN   /* 계약진행상태메모내용 */
             , DSB_GUR_TP_CD          /* 지급보증유형코드 */
             , CNTR_INFLW_PH_DV_CD    /* 계약유입경로구분코드 */
             , PSPC_CST_ID            /* 가망고객ID */
             , CNTR_CH_RCP_ID         /* 계약변경접수ID */
             , DCEVDN_DOC_ID          /* 증빙서류문서ID */
             , DTA_DL_YN              /* 데이터삭제여부 */
             , FST_RGST_DTM           /* 최초등록일시 */
             , FST_RGST_USR_ID        /* 최초등록사용자ID */
             , FST_RGST_PRG_ID        /* 최초등록프로그램ID */
             , FST_RGST_DEPT_ID       /* 최초등록부서ID */
             , FNL_MDFC_DTM           /* 최종수정일시 */
             , FNL_MDFC_USR_ID        /* 최종수정사용자ID */
             , FNL_MDFC_PRG_ID        /* 최종수정프로그램ID */
             , FNL_MDFC_DEPT_ID       /* 최종수정부서ID */
          FROM TB_SSCT_CNTR_BAS
         WHERE 1=1
           AND CNTR_NO = #{dtlCntrNo}
    </insert>

    <insert id="insertContractStlmRel">
        INSERT INTO TB_SSCT_CNTR_STLM_REL (
               CNTR_STLM_REL_ID		/* 계약결제관계ID*/
             , VL_STRT_DTM			/* 유효시작일시*/
             , VL_END_DTM			/* 유효종료일시*/
             , CNTR_UNIT_TP_CD		/* 계약단위유형코드*/
             , CNTR_STLM_ID			/* 계약결제ID*/
             , CNTR_NO				/* 계약번호*/
             , DTL_CNTR_NO			/* 상세계약번호*/
             , DTL_CNTR_SN			/* 상세계약일련번호*/
             , DP_TP_CD				/* 입금유형코드*/
             , RVE_DV_CD			/* 수납구분코드*/
             , ISLND_INCMDC_TP_CD	/* 도서지역소득공제유형코드*/
             , STLM_AMT				/* 결제금액*/
             , STLM_HD_DV_CD		/* 결제보류구분코드*/
             , BF_CNTR_STLM_ID		/* 이전계약결제ID*/
             , DTA_DL_YN			/* 데이터삭제여부*/
             <include refid="COMMON.insertSystemField" />
        ) SELECT CNTR_STLM_REL_ID	/* 계약결제관계ID*/
               , #{histStrtDtm}	    /* 유효시작일시*/
               , #{histEndDtm}	    /* 유효종료일시*/
               , CNTR_UNIT_TP_CD	/* 계약단위유형코드*/
               , CNTR_STLM_ID		/* 계약결제ID*/
               , CNTR_NO			/* 계약번호*/
               , DTL_CNTR_NO		/* 상세계약번호*/
               , DTL_CNTR_SN		/* 상세계약일련번호*/
               , DP_TP_CD			/* 입금유형코드*/
               , RVE_DV_CD			/* 수납구분코드*/
               , ISLND_INCMDC_TP_CD	/* 도서지역소득공제유형코드*/
               , STLM_AMT			/* 결제금액*/
               , STLM_HD_DV_CD		/* 결제보류구분코드*/
               , BF_CNTR_STLM_ID	/* 이전계약결제ID*/
               , 'N'				/* 데이터삭제여부*/
               , #{fstRgstDtm}
               , #{fstRgstUsrId}
               , #{fstRgstPrgId}
               , #{fstRgstDeptId}
               , #{fnlMdfcDtm}
               , #{fnlMdfcUsrId}
               , #{fnlMdfcPrgId}
               , #{fnlMdfcDeptId}
             FROM TB_SSCT_CNTR_STLM_REL
            WHERE CNTR_STLM_ID = #{cntrStlmId}
              AND VL_END_DTM   = #{histStrtDtm}
              AND DTL_CNTR_NO  = #{cntrNo}
              AND DTL_CNTR_SN  = #{cntrSn}
              AND DTA_DL_YN    = 'N'
    </insert>

    <insert id="insertContractStlHist">
        INSERT INTO TB_SSCT_CNTR_STLM_CH_HIST (
              CNTR_STLM_ID
            , HIST_STRT_DTM
            , HIST_END_DTM
            , CST_NO
            , CNTR_NO
            , CNTRT_REL_CD
            , OWR_KNM
            , DP_TP_CD
            , BNK_CD
            , CDCO_CD
            , ACNO_ENCR
            , CRCDNO_ENCR
            , CARD_EXPDT_YM
            , MPY_BSDT
            , HS_CTF_YN
            , VNCO_DV_CD
            , PYER_NO
            , FNIT_APR_RS_CD
            , AC_FNT_IMPS_CD
            , CARD_FNT_IMPS_CD
            , FNT_EVID_DRM_VAL
            , REUSE_OJ_YN
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" />
        ) SELECT CNTR_STLM_ID
               , #{histStrtDtm}
               , #{histEndDtm}
               , CST_NO
               , CNTR_NO
               , CNTRT_REL_CD
               , OWR_KNM
               , DP_TP_CD
               , BNK_CD
               , CDCO_CD
               , ACNO_ENCR
               , CRCDNO_ENCR
               , CARD_EXPDT_YM
               , MPY_BSDT
               , HS_CTF_YN
               , VNCO_DV_CD
               , PYER_NO
               , FNIT_APR_RS_CD
               , AC_FNT_IMPS_CD
               , CARD_FNT_IMPS_CD
               , FNT_EVID_DRM_VAL
               , REUSE_OJ_YN
               , DTA_DL_YN
               , #{fstRgstDtm}
               , #{fstRgstUsrId}
               , #{fstRgstPrgId}
               , #{fstRgstDeptId}
               , #{fnlMdfcDtm}
               , #{fnlMdfcUsrId}
               , #{fnlMdfcPrgId}
               , #{fnlMdfcDeptId}
             FROM TB_SSCT_CNTR_STLM_BAS
            WHERE CNTR_STLM_ID = #{cntrStlmId}
              AND DTA_DL_YN = 'N'
    </insert>

    <update id="updateContractAdrpcBase">
        UPDATE TB_SSCT_CNTR_ADRPC_BAS B01 /* 계약주소지기본*/
           SET B01.RCGVP_KNM = #{istNm}
         WHERE B01.CNTR_ADRPC_ID = (
                SELECT A01.CNTR_ADRPC_ID /* 계약주소지ID*/
                  FROM TB_SSCT_CNTR_ADR_REL A01 /* 계약주소관계*/
                 WHERE 1 = 1
                   AND A01.ADRPC_TP_CD = '3' /* 주소지유형코드 - 3:설치주소*/
                   AND A01.DTL_CNTR_NO = #{dtlCntrNo}
                   AND A01.DTL_CNTR_SN = #{dtlCntrSn}
                   AND A01.VL_END_DTM = '99991231235959'
                   AND A01.DTA_DL_YN = 'N'
                   AND ROWNUM = 1
               )
    </update>
    <update id="updateContractDetail">
        UPDATE TB_SSCT_CNTR_DTL /* 계약상세*/
           SET TXINV_PBL_OJ_YN = #{pblYn} /* 세금계산서발행대상여부*/
         WHERE CNTR_NO = #{dtlCntrNo}
           AND CNTR_SN = #{dtlCntrSn}
           AND DTA_DL_YN = 'N'
    </update>

    <update id="updateContractBase">
        UPDATE TB_SSCT_CNTR_BAS /* 계약기본*/
           SET SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd} /* 판매유입채널상세코드 */
             , SELL_OG_TP_CD = #{ogTpCd} /* 판매조직유형코드 */
             , SELL_PRTNR_NO = #{prtnrNo} /* 판매파트너번호 */
         WHERE CNTR_NO = #{dtlCntrNo}
           AND DTA_DL_YN = 'N'
    </update>

    <update id="updateContractStlmRel">
        UPDATE TB_SSCT_CNTR_STLM_REL
           SET VL_END_DTM = #{histStrtDtm}
        <choose>
            <when test='@MybatisUtils@equals(fntDvCd, "N")'>
                , STLM_HD_DV_CD = 'N'
            </when>
            <when test='@MybatisUtils@equals(fntDvCd, "B")'>
                , STLM_HD_DV_CD = NULL
            </when>
            <when test='@MybatisUtils@equals(fntDvCd, "S")'>
                , DP_TP_CD = '0101' /* 개별수납(가상계좌)*/
            </when>
             <when test='@MybatisUtils@equals(fntDvCd, "G")'>
                , DP_TP_CD = '0401' /* 지로*/
            </when>
            <otherwise>
            </otherwise>
        </choose>
          <include refid="COMMON.updateSystemField"/>
         WHERE DTL_CNTR_NO = #{cntrNo}
           AND DTL_CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N'
           AND VL_END_DTM = '99991231235959'
    </update>

    <update id="updateContractStlmBas">
        UPDATE TB_SSCT_CNTR_STLM_BAS /* 계약결제기본*/
           SET
        <choose>
            <when test='@MybatisUtils@equals(fntDvCd, "S")'>
                DP_TP_CD  = '0101' /* 개별수납(가상계좌)*/
            </when>
            <when test='@MybatisUtils@equals(fntDvCd, "G")'>
                DP_TP_CD  = '0401' /* 지로*/
            </when>
            <otherwise>
            </otherwise>
        </choose>
          <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_STLM_ID = #{cntrStlmId}
           AND DTA_DL_YN = 'N'
    </update>

     <update id="updateContractStlHist">
        UPDATE TB_SSCT_CNTR_STLM_CH_HIST
           SET HIST_END_DTM = #{histStrtDtm}
          <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_STLM_ID = #{cntrStlmId}
           AND HIST_END_DTM = '99991231235959'
    </update>
</mapper>
