<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.changeorder.mapper.WctbRentalBulkChangeMapper">

    <select id="selectRentalBulkChanges" resultType="com.kyowon.sms.wells.web.contract.changeorder.dvo.WctbRentalBulkChangeDvo">

        SELECT T2.CNTR_CH_RCP_ID    /* 계약변경접수ID */
             , T2.DTL_CNTR_NO       /* 계약번호 LCYEAR , LCCODE */
             , T2.DTL_CNTR_SN
             , T2.DTL_CNTR_NO ||'-'|| T2.DTL_CNTR_SN AS CNTR_DTL_NO  /* 계약상세번호 (고객코드:LCYCODE) */
             , T11.SELL_TP_CD       /* 판매유형 코드 */
             , T1.CNTR_CH_TP_CD     /* 계약변경유형코드 (처리구분 : DSPSDIV) */
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS T40 WHERE T40.CST_NO = T10.CNTR_CST_NO AND T40.DTA_DL_YN = 'N') AS CST_KNM /* 계약자정보 - 고객명(LCCNAM) */
             , T12.IST_DT           /* 설치일자 (설치일자:LCSETY, INLTDT)*/
            -------------------------------------------------------------
            <![CDATA[
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '설치년월' )        AS IST_YM   /* 설치년월 (설치년월:LCSETT ) 604 설치월면제, 613  미관리제품 설치일자 변경 */
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '의무기간 변경전' )    AS BFCH_DUTY_PTRM_N   /* 의무기간 변경전(변경전 의무기간수) (의무기간 원본:LCDUTY_OLD ) 605 의무기간 */
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '의무기간 변경후' )    AS AFCH_DUTY_PTRM_N   /* 의무기간 변경후 (의무기간 변경:LCDUTY_NEW ) 605    의무기간*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '인정실적금액' )      AS ACKMT_PERF_AMT   /* 인정실적금액 (인정실적금액:LCPAMT ) 608   인정실적 금액변경 */
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '수수료기준가격' )     AS FEE_BASE_AMT   /* 수수료기준가격 (수수료기준가격:LCGUB5 ) 609  수수료 기준가격변경*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '수수료인정건수' )     AS FEE_ACKMT_CT   /* 수수료인정건수 (인정건수:LCPCNT ) 611 수수료 인정건수 변경*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '렌탈할인금액' )      AS RENTAL_DSC_AMT   /* 렌탈할인금액 (렌탈료DC금액:LCRAM1 ) 612  렌탈료DC 변경 */
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '제품고유번호' )      AS PDCT_IDNO   /* 제품고유번호 (변경시리얼 번호:LCSRNO ) 615  시리얼 번호 변경*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '시작기간' )        AS STP_STRT_YM   /* 시작기간(중지시작년월) : 중지기간(시작) :  STRYM2  ) 616   법인 코로나 렌탈중지 , 617   법인 코로나 렌탈중지 취소*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '종료기간' )        AS STP_END_YM   /* 종료기간 (중지종료년월)  (중지기간(종료) :  ENDYM, ENDYM2  616  법인 코로나 렌탈중지*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '휴대전화1' )       AS CRAL_LOCARA_TNO   /* 휴대전화1  (휴대전화1 :  LCCNO1 616   법인 코로나 렌탈중지*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '휴대전화2' )       AS MEXNO_ENCR   /* 휴대전화2  (휴대전화2 :  LCCNO2 616    법인 코로나 렌탈중지*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '휴대전화3' )       AS CRAL_IDV_TNO   /* 휴대전화3  (휴대전화3 :  LCCNO3 616  법인 코로나 렌탈중지*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '수수료정액여부' )     AS FEE_FXAM_YN   /* 수수료정액여부  (수수료 정액여부 :  LCST13 , 618  수수료 정액여부 변경*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '프로모션할인금액' )    AS PMOT_DSC_MCN   /* 할인개월 (수수료기준가격:LCGUB5 ) 619    프로모션 렌탈료 할인  (ASIS에서 수수료기준가격과 동일한 컬럼을 사용했었음.)*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '인정실적금액' )      AS PMOT_DSC_AMT   /* 할인금액 (인정실적금액:LCPAMT ) 619   프로모션 렌탈료 할인  (ASIS에서 인정실적금액과 동일한 컬럼을 사용했었음.)*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '인정실적금액' )      AS SDING_ACKMT_PERF_AMT   /* 수당건수 인정 (인정실적금액:LCPAMT ) 621    (모종)인정실적금액변경  (ASIS에서 수수료기준가격과 동일한 컬럼을 사용했었음.)*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '수수료기준가격' )     AS SDING_FEE_BASE_AMT   /* 수수료기준가격 (수수료기준가격:LCGUB5 ) 622    (모종)수수료기준가격변경  (ASIS에서 수수료기준가격과 동일한 컬럼을 사용했었음.)*/
             , T11.FEE_ACKMT_CT AS BFCH_FEE_ACKMT_CT    /* 수수료기준가격(현재,변경전) 626  (모종)수수료 인정건수 변경 */
             , T12.BFSVC_BZS_DV_CD                      /* BS업체구분코드  (업체BS구분 : LC349.LCFLG1,  0 - 일반BS, 1:업체BS  2:배송없음－요청시배송  ) 711  BS업체구분값 변경*/
             , T12.SPLY_BZS_DV_CD                       /* 조달업체구분코드 (업체구분 : LC349.LCFLG2 , 키위에서 사용  ) 711 BS업체구분값 변경*/
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 수수료정액여부 : Y|렌탈할인금액 : 123|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '컨택코드' )        AS CTT_TP_CD   /* 컨택유형코드 (컨택코드:LCCCDE ) 602    컨택코드 - 사용하지는 변경유형코드 */
             , (SELECT V /* MIG 데이타 기준 변경요청시 값 추출 EX) 예정일자 : 20230101|  */
                  FROM (SELECT TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 1)) AS K
                             , TRIM(REGEXP_SUBSTR(REGEXP_SUBSTR(T2.CNTR_CH_AK_CN, '[^|]+', 1, ROWNUM), '[^:]+', 1, 2)) AS V
                          FROM DUAL CONNECT BY ROWNUM <= LENGTH(NVL(REGEXP_REPLACE(T2.CNTR_CH_AK_CN, '[^|]+', ''), 0)) + 1 )
                  WHERE 1=1 AND K = '예정일자' )        AS DUEDT   /* 예정일자 (예정일자:LCDEMT ) 603  예정일자 - 사용하지는 변경유형코드 */
             ]]>
                 -------------------------------------------------------------
             , T1.CNTR_CH_AK_CN /* 계약변경요청내용 : (비고 : LCMEMO)*/
             , RPAD(T2.FST_RGST_DTM, 14, '0') AS FST_RGST_DTM
             , T2.FST_RGST_USR_ID   /* 최초등록사용자 (등록자 : REGNO) */
             , F_CMZ_USR_NM(T2.FST_RGST_USR_ID) AS FST_RGST_USR_NM /* 최초등록사용자명 (이름 : ISCNAM)*/
          FROM TB_SSCT_CNTR_CH_RCP_BAS T1          /* T.계약변경접수기본 (ASIS:RNTL_BNDE_CHNG) */
         INNER JOIN TB_SSCT_CNTR_CH_RCP_DTL T2    /* T.계약변경접수상세 (ASIS:RNTL_BNDE_CHNG) */
            ON T2.CNTR_CH_RCP_ID = T1.CNTR_CH_RCP_ID
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_BAS T10            /* T.계약기본 */
            ON T10.CNTR_NO = T2.DTL_CNTR_NO
           AND T10.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_DTL T11            /* T.계약상세  LC3100P*/
            ON T11.CNTR_NO = T2.DTL_CNTR_NO
           AND T11.CNTR_SN = T2.DTL_CNTR_SN
           AND T11.DTA_DL_YN = 'N'
          LEFT OUTER  JOIN TB_SSCT_CNTR_WELLS_DTL T12  /* T.WELLS상세 */
            ON T12.CNTR_NO = T11.CNTR_NO
           AND T12.CNTR_SN = T11.CNTR_SN
           AND T12.DTA_DL_YN = 'N'
         WHERE T1.DTA_DL_YN = 'N'
           AND T11.SELL_TP_CD = '2' /*판매유형코드 : 렌탈/리스(2) */
           AND T1.CNTR_CH_TP_CD  = #{cntrChTpCd} /* P1.기본조회조건 : 계약변경유형코드(필수) */
           <choose>
               <when test='@MybatisUtils@equals(srchDiv, "2")'>
                    /* P3.구분상세 : 계약번호 선택시 */
                    AND T2.DTL_CNTR_NO  = #{cntrNo}
                    AND T2.DTL_CNTR_SN  = #{cntrSn}
               </when>
               <otherwise>
                   /* P2.구분상세 : 반영년월 선택시 : 등록일자 기간 */
                   AND T2.FST_RGST_DTM BETWEEN  #{srchDt}||'01000000' AND #{srchDt}|| '31235959'
               </otherwise>
           </choose>
         ORDER BY T2.FST_RGST_DTM DESC
    </select>
</mapper>
