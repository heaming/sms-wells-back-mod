<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaEmployeePrchsGcfMngtMapper">
    <select id="selectEmployeePurchaseGcfs" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dvo.WctaEmployeePrchsGcfMngtDvo">
        WITH W1 AS (
        SELECT
               MAX(B1.SELL_PRTNR_NO) AS SELL_PRTNR_NO /* 판매자사번 */
             , MAX(B1.SELL_OG_TP_CD) AS SELL_OG_TP_CD /* 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) */
             , MAX(B1.CNTR_TP_CD) AS CNTR_TP_CD /* 계약유형코드 = '03' 임직원일때 직원구매로 보면 되는지 확인 필요 */
             , MAX(B1.CNTR_CNFM_DTM) AS CNTR_CNFM_DTM /* 계약확정일자 */
             , MAX(C1.IST_DT) AS IST_DT /* 설치일자 */
             , MAX(C1.REQD_DT) AS REQD_DT /* 철거일자 */
             , MAX(A1.CNTR_DTL_STAT_CD) AS CNTR_DTL_STAT_CD /* 301 고객요청해야, 302 연체해약, 303 계약취소 */
             , MAX(B1.SELL_INFLW_CHNL_DTL_CD) AS SELL_INFLW_CHNL_DTL_CD /* 판매유입채널상세코드 9020 일때 직원구매 */
             , TO_CHAR(TRUNC(SYSDATE, 'MM'), 'YYYYMM') AS BASE_YM /* 기준년월 */
             , TO_CHAR(TRUNC(SYSDATE, 'MM'), 'YYYY') AS BASE_YY /* 기준년도 */
             , A1.CNTR_NO
             , A1.CNTR_SN
             , MAX(A1.CNTR_PD_STRTDT) AS CNTR_PD_STRTDT /* 계약상품시작일자 */
             , MAX(A1.CNTR_PD_ENDDT) AS CNTR_PD_ENDDT /* 계약상품종료일자 */
             , CASE WHEN     COUNT(D1.CNTRT_REL_CD) <![CDATA[ > ]]> 1 /* 계약자 관계코드 건수가 1초과(1건 보다 많으면 최종건으로 조회) */
                         AND MAX(D1.VL_END_DTM) != '99991231235959' /* 건수가 여러개고 유효종료일시가 '99991231235959' 가 아니면 */
                         THEN MAX(D1.CNTRT_REL_CD) KEEP (DENSE_RANK FIRST ORDER BY D1.VL_END_DTM DESC NULLS LAST)
                    ELSE MAX(D1.CNTRT_REL_CD)
               END AS CNTRT_REL_CD /* 계약자관계코드 */
          FROM TB_SSCT_CNTR_DTL A1  /* 계약상세 */
         INNER JOIN TB_SSCT_CNTR_BAS B1  /* 계약기본 */
            ON B1.CNTR_NO = A1.CNTR_NO
           AND B1.DTA_DL_YN = 'N'
           AND A1.DTA_DL_YN = 'N'
          LEFT OUTER  JOIN TB_SSCT_CNTR_WELLS_DTL C1 /* 계약WELLS상세 - 매출일 렌탈의 경우 설치일자가 매출인식일자로 처리 되므로 INNER로 변경 */
            ON C1.CNTR_NO = A1.CNTR_NO
           AND C1.CNTR_SN = A1.CNTR_SN
           AND C1.DTA_DL_YN = 'N'
           AND A1.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_CST_REL D1 /* T.계약자관계코드 */
            ON D1.DTL_CNTR_NO = A1.CNTR_NO
           AND D1.DTL_CNTR_SN = A1.CNTR_SN
           AND D1.CNTR_CST_REL_TP_CD = '10' /* 계약자 */
           AND D1.DTA_DL_YN = 'N'
         WHERE C1.IST_DT <![CDATA[ >= ]]>#{istDt}||'0101'
           AND A1.SELL_TP_CD = '2'    /* 렌탈 */
           AND C1.IST_DT IS NOT NULL
           AND TO_DATE(C1.IST_DT, 'YYYYMMDD') + 14 <![CDATA[ <= ]]> SYSDATE
           --AND B1.CNTR_TP_CD = '03' /* 계약유형코드 = '03' 임직원일때 직원구매로 보면 되는지 확인 필요 */
           AND (   B1.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020') /* 1030:정규직원, 1040:계약직원, 9020:직원구매 */
                OR B1.SELL_PRTNR_NO IN (  '1525290' /*구몬학습*/
                                        , '1650501' /*에듀*/
                                        , '1564070' /*수학달인*/
                                        , '1593484'/*도요새*/
                                        , '1712367' /*더퍼스트*/
                                        , '1743635' /*직원구매*/
                                        , '1743636' /*57차월*/
                                        , '1743637' /*이자제휴*/)
               )
           GROUP BY A1.CNTR_NO, A1.CNTR_SN /* 계약번호, 계약일련번호 GROUP */
        )
        , W2 AS (
        SELECT R.PRTNR_NO /* 파트너번호 */
             , R.ALNC_PRTNR_DRM_VAL /* 제휴파트너 : 제휴파트너식별값 */
             , R.CNTR_NO
         FROM TB_SSCT_CNTR_PRTNR_REL R /* 계약파트너관계 */
        INNER JOIN W1
           ON W1.CNTR_NO = R.CNTR_NO
          AND W1.SELL_PRTNR_NO = R.PRTNR_NO
          AND R.DTA_DL_YN = 'N'
          AND W1.IST_DT BETWEEN R.VL_STRT_DTM AND R.VL_END_DTM
        WHERE 1=1
          AND R.CNTR_PRTNR_TP_CD = '010'
          AND R.ALNC_PRTNR_DRM_VAL != '0'
          AND R.PRTNR_NO IN (  '1525290' /*구몬학습*/
                             , '1650501' /*에듀*/
                             , '1564070' /*수학달인*/
                             , '1593484'/*도요새*/
                             , '1712367' /*더퍼스트*/
                            )
        GROUP BY R.PRTNR_NO /* 파트너번호 */
               , R.ALNC_PRTNR_DRM_VAL /* 제휴파트너 : 제휴파트너식별값 */
               , R.CNTR_NO /* 계약번호 */
        )
        SELECT I3.EMPNO
             , I3.EMP_DV
             , I3.SELL_INFLW_CHNL_DTL_CD
             , I3.PRTNR_KNM
             , I3.CRAL_LOCARA_TNO
             , I3.MEXNO_ENCR
             , I3.CRAL_IDV_TNO
             , I3.CRAL_TNO
             , I3.RSGN_DT
             , I3.BF_IST_CN
             , I3.BF_CAN_CN
             , I3.BF_FNL_CN
             , I3.THM_IST_CN
             , I3.THM_CAN_CN
             , I3.THM_FNL_CN
             , I3.MTH01_IST_CN
             , I3.MTH01_CAN_CN
             , I3.MTH01_FNL_CN
             , I3.MTH02_IST_CN
             , I3.MTH02_CAN_CN
             , I3.MTH02_FNL_CN
             , I3.MTH03_IST_CN
             , I3.MTH03_CAN_CN
             , I3.MTH03_FNL_CN
             , I3.MTH04_IST_CN
             , I3.MTH04_CAN_CN
             , I3.MTH04_FNL_CN
             , I3.MTH05_IST_CN
             , I3.MTH05_CAN_CN
             , I3.MTH05_FNL_CN
             , I3.MTH06_IST_CN
             , I3.MTH06_CAN_CN
             , I3.MTH06_FNL_CN
             , I3.MTH07_IST_CN
             , I3.MTH07_CAN_CN
             , I3.MTH07_FNL_CN
             , I3.MTH08_IST_CN
             , I3.MTH08_CAN_CN
             , I3.MTH08_FNL_CN
             , I3.MTH09_IST_CN
             , I3.MTH09_CAN_CN
             , I3.MTH09_FNL_CN
             , I3.MTH10_IST_CN
             , I3.MTH10_CAN_CN
             , I3.MTH10_FNL_CN
             , I3.MTH11_IST_CN
             , I3.MTH11_CAN_CN
             , I3.MTH11_FNL_CN
             , I3.MTH12_IST_CN
             , I3.MTH12_CAN_CN
             , I3.MTH12_FNL_CN
             , I3.TOT_IST_CN
             , I3.TOT_CAN_CN
             , I3.TOT_FNL_CN
          FROM
             (
                    SELECT I2.EMPNO
                   , I2.EMP_DV
                   , CASE WHEN I2.EMP_DV = 'EMPL'
                                THEN '임직원'
                          ELSE MAX(I2.SELL_PRTNR_NM)
                     END AS SELL_INFLW_CHNL_DTL_CD
                   , MAX(I2.PRTNR_KNM) AS PRTNR_KNM /* 파트너한글명 */
                   , MAX(I2.CRAL_LOCARA_TNO) AS CRAL_LOCARA_TNO /* 휴대지역전화번호 */
                   , MAX(I2.MEXNO_ENCR) AS MEXNO_ENCR /* 휴대전화국번호암호화 */
                   , MAX(I2.CRAL_IDV_TNO) AS CRAL_IDV_TNO /* 휴대개별전화번호 */
                   , '' AS CRAL_TNO
                   , (SELECT
                              MAX(E2.RSGN_DT) /* 퇴사일 */
                         FROM (
                               SELECT E1.SAP_REF_EMPNO_VAL
                                    , E1.RSGN_DT
                                 FROM TB_GBCO_EMP_BAS E1 /* 직원기본 */
                                WHERE E1.DTA_DL_YN = 'N'
                                START WITH E1.SAP_EMPNO = I2.EMPNO
                              CONNECT BY PRIOR E1.SAP_REF_EMPNO_VAL = E1.SAP_EMPNO
                              ) E2
                        WHERE E2.SAP_REF_EMPNO_VAL = '0' /* 최종키 */
                     ) AS RSGN_DT /* 퇴사일 */
                   , SUM(I2.BF_IST_CN) AS BF_IST_CN /* 이전설치건수 */
                   , SUM(I2.BF_CAN_CN) AS BF_CAN_CN /* 이전취소건수 */
                   , (SUM(I2.BF_IST_CN) - SUM(I2.BF_CAN_CN)) AS BF_FNL_CN /* 이전최종건수 */
                   , SUM(I2.THM_IST_CN) AS THM_IST_CN /* 당월설치건수 */
                   , SUM(I2.THM_CAN_CN) AS THM_CAN_CN /* 당월취소건수 */
                   , (SUM(I2.THM_IST_CN) - SUM(I2.THM_CAN_CN)) AS THM_FNL_CN /* 당월최종건수 */
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH01_IST_CN) AS MTH01_IST_CN /* 1월설치건수 */
                   , SUM(I2.MTH01_CAN_CN) AS MTH01_CAN_CN /* 1월취소건수 */
                   , (SUM(I2.MTH01_IST_CN) - SUM(I2.MTH01_CAN_CN)) AS MTH01_FNL_CN /* 1월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH02_IST_CN) AS MTH02_IST_CN /* 2월설치건수 */
                   , SUM(I2.MTH02_CAN_CN) AS MTH02_CAN_CN /* 2월취소건수 */
                   , (SUM(I2.MTH02_IST_CN) - SUM(I2.MTH02_CAN_CN)) AS MTH02_FNL_CN /* 2월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH03_IST_CN) AS MTH03_IST_CN /* 3월설치건수 */
                   , SUM(I2.MTH03_CAN_CN) AS MTH03_CAN_CN /* 3월취소건수 */
                   , (SUM(I2.MTH03_IST_CN) - SUM(I2.MTH03_CAN_CN)) AS MTH03_FNL_CN /* 3월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH04_IST_CN) AS MTH04_IST_CN /* 4월설치건수 */
                   , SUM(I2.MTH04_CAN_CN) AS MTH04_CAN_CN /* 4월취소건수 */
                   , (SUM(I2.MTH04_IST_CN) - SUM(I2.MTH04_CAN_CN)) AS MTH04_FNL_CN /* 4월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH05_IST_CN) AS MTH05_IST_CN /* 5월설치건수 */
                   , SUM(I2.MTH05_CAN_CN) AS MTH05_CAN_CN /* 5월취소건수 */
                   , (SUM(I2.MTH05_IST_CN) - SUM(I2.MTH05_CAN_CN)) AS MTH05_FNL_CN /* 5월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH06_IST_CN) AS MTH06_IST_CN /* 6월설치건수 */
                   , SUM(I2.MTH06_CAN_CN) AS MTH06_CAN_CN /* 6월취소건수 */
                   , (SUM(I2.MTH06_IST_CN) - SUM(I2.MTH06_CAN_CN)) AS MTH06_FNL_CN /* 6월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH07_IST_CN) AS MTH07_IST_CN /* 7월설치건수 */
                   , SUM(I2.MTH07_CAN_CN) AS MTH07_CAN_CN /* 7월취소건수 */
                   , (SUM(I2.MTH07_IST_CN) - SUM(I2.MTH07_CAN_CN)) AS MTH07_FNL_CN /* 7월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH08_IST_CN) AS MTH08_IST_CN /* 8월설치건수 */
                   , SUM(I2.MTH08_CAN_CN) AS MTH08_CAN_CN /* 8월취소건수 */
                   , (SUM(I2.MTH08_IST_CN) - SUM(I2.MTH08_CAN_CN)) AS MTH08_FNL_CN /* 8월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH09_IST_CN) AS MTH09_IST_CN /* 9월설치건수 */
                   , SUM(I2.MTH09_CAN_CN) AS MTH09_CAN_CN /* 9월취소건수 */
                   , (SUM(I2.MTH09_IST_CN) - SUM(I2.MTH09_CAN_CN)) AS MTH09_FNL_CN /* 9월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH10_IST_CN) AS MTH10_IST_CN /* 10월설치건수 */
                   , SUM(I2.MTH10_CAN_CN) AS MTH10_CAN_CN /* 10월취소건수 */
                   , (SUM(I2.MTH10_IST_CN) - SUM(I2.MTH10_CAN_CN)) AS MTH10_FNL_CN /* 10월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH11_IST_CN) AS MTH11_IST_CN /* 11월설치건수 */
                   , SUM(I2.MTH11_CAN_CN) AS MTH11_CAN_CN /* 11월취소건수 */
                   , (SUM(I2.MTH11_IST_CN) - SUM(I2.MTH11_CAN_CN)) AS MTH11_FNL_CN /* 11월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.MTH12_IST_CN) AS MTH12_IST_CN /* 12월설치건수 */
                   , SUM(I2.MTH12_CAN_CN) AS MTH12_CAN_CN /* 12월취소건수 */
                   , (SUM(I2.MTH12_IST_CN) - SUM(I2.MTH12_CAN_CN)) AS MTH12_FNL_CN /* 12월최종건수 */
              ------------------------------------------------------------------------------------
              ------------------------------------------------------------------------------------
                   , SUM(I2.TOT_IST_CN) AS TOT_IST_CN /* 전체설치건수 */
                   , SUM(I2.TOT_CAN_CN) AS TOT_CAN_CN /* 전체취소건수 */
                   , (SUM(I2.TOT_IST_CN) - SUM(I2.TOT_CAN_CN)) AS TOT_FNL_CN /* 전체최종건수 */
              ------------------------------------------------------------------------------------
              --     , (
              --        SELECT COUNT(*)
              --          FROM TB_GBCO_EMP_BAS E1 /* 직원기본 */
              --         WHERE E1.DTA_DL_YN = 'N'
              --           AND E1.SAP_REF_EMPNO_VAL = I2.EMPNO /* 제휴파트너식별값 =  */
              --       ) AS EMP_CHK_CN /* 한건이라도 있으면 사번변경 조회 - 확인용 추가하면 느려짐  */
              --     , MAX(I2.OG_NM) AS OG_NM /* 소속 */
              --     , (SELECT MAX(D1.PRTNR_KNM) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) /* 파트너한글명 */
              --          FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
              --         WHERE D1.PRTNR_NO = I2.EMPNO
              --         GROUP BY D1.PRTNR_NO) AS PRTNR_KNM
              --     , (SELECT MAX(D1.CRAL_LOCARA_TNO) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) /* 휴대지역전화번호 */
              --          FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
              --         WHERE D1.PRTNR_NO = I2.EMPNO
              --         GROUP BY D1.PRTNR_NO) AS CRAL_LOCARA_TNO
              --     , (SELECT MAX(D1.MEXNO_ENCR) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) /* 휴대전화국번호암호화 */
              --          FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
              --         WHERE D1.PRTNR_NO = I2.EMPNO
              --         GROUP BY D1.PRTNR_NO) AS MEXNO_ENCR
              --     , (SELECT MAX(D1.CRAL_IDV_TNO) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) /* 휴대개별전화번호 */
              --          FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
              --         WHERE D1.PRTNR_NO = I2.EMPNO
              --         GROUP BY D1.CRAL_IDV_TNO) AS CRAL_IDV_TNO
                FROM
                     (
                      SELECT I1.EMPNO
                           , I1.EMP_DV
                           , I1.BASE_YM
                           , I1.BASE_YY
                           , I1.SELL_PRTNR_NO /* 판매파트너번호 */
                           , I1.SELL_PRTNR_NM /* 판매파트너명 */
                           , I1.ALNC_PRTNR_DRM_VAL /* 제휴파트너식별값 */
                           , D2.PRTNR_KNM /* 파트너한글명 */
                           , D2.CRAL_LOCARA_TNO/* 휴대지역전화번호 */
                           , D2.MEXNO_ENCR/* 휴대전화국번호암호화 */
                           , D2.CRAL_IDV_TNO/* 휴대개별전화번호 */
                           , CASE WHEN I1.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020')
                                       THEN '임직원'
                                  ELSE
                                       (
                                        SELECT MAX(F1.OG_NM) /* 조직명 */
                                          FROM TB_OGBS_MM_PRTNR_IZ F1 /* 월파트너내역 */
                                         WHERE F1.PRTNR_NO = I1.SELL_PRTNR_NO /* 제휴파트너식별값(ALNC_PRTNR_DRM_VAL)로 대체 된 경우 조회되지 않음 */
                                           AND F1.BASE_YM = SUBSTR(I1.CNTR_CNFM_DTM, 1, 6)
                                           -- AND F1.OG_TP_CD = I1.SELL_OG_TP_CD /* 20230728 확인시 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) */
                                           AND F1.DTA_DL_YN = 'N'
                                       )
                             END AS OG_NM /* 소속 */
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) <![CDATA[ < ]]> I1.BASE_YM /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END BF_IST_CN /* 이전설치건수 */
                             /* 당월설치, 당월취소건  */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) <![CDATA[ < ]]>I1.BASE_YM /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) <![CDATA[ < ]]>I1.BASE_YM /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                      --                 AND SUBSTR(I1.REQD_DT, 1, 6) <![CDATA[ < ]]>I1.BASE_YM /* 철거일자 */
                      --                 AND I1.REQD_DT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END BF_CAN_CN /* 이전취소건수  */
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YM /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END THM_IST_CN /* 당월설치건수 */
                             /* 당월설치, 당월취소건  */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YM /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YM /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                      --                 AND SUBSTR(I1.REQD_DT, 1, 6) <![CDATA[ < ]]> I1.BASE_YM /* 철거일자 */
                      --                 AND I1.REQD_DT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END THM_CAN_CN /* 당월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'01' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH01_IST_CN /* 1월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'01' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'01' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH01_CAN_CN /* 1월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'02' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH02_IST_CN /* 2월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'02' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'02' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH02_CAN_CN /* 2월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'03' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH03_IST_CN /* 3월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'03' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'03' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH03_CAN_CN /* 3월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'04' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH04_IST_CN /* 4월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'04' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'04' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH04_CAN_CN /* 4월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'05' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH05_IST_CN /* 5월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'05' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'05' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH05_CAN_CN /* 5월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'06' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH06_IST_CN /* 6월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'06' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'06' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH06_CAN_CN /* 6월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'07' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH07_IST_CN /* 7월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'07' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'07' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH07_CAN_CN /* 7월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'08' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH08_IST_CN /* 8월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'08' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'08' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH08_CAN_CN /* 8월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'09' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH09_IST_CN /* 9월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'09' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'09' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH09_CAN_CN /* 9월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'10' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH10_IST_CN /* 10월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'10' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'10' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH10_CAN_CN /* 10월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'11' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH11_IST_CN /* 11월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'11' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'11' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH11_CAN_CN /* 11월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'12' /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END MTH12_IST_CN /* 12월설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 6) = I1.BASE_YY||'12' /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 6) = I1.BASE_YY||'12' /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END MTH12_CAN_CN /* 12월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                      ---------------------------------------------------------------------------------------------------------------
                           , CASE WHEN SUBSTR(I1.IST_DT, 1, 4) = I1.BASE_YY /* 설치일자 */
                                       THEN 1
                                  ELSE 0
                             END TOT_IST_CN /* 전체설치건수 */
                           , CASE WHEN     SUBSTR(I1.IST_DT, 1, 4) = I1.BASE_YY /* 설치일자 */
                                       AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
                                       AND SUBSTR(I1.CNTR_PD_ENDDT, 1, 4) = I1.BASE_YY /* 계약상품종료일자 */
                                       AND I1.CNTR_PD_ENDDT IS NOT NULL
                                       THEN 1
                                  ELSE 0
                             END TOT_CAN_CN /* 12월취소건수  */
                      ---------------------------------------------------------------------------------------------------------------
                        FROM
                           (
                            SELECT
                                   CASE WHEN W1.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020')
                                             THEN W1.SELL_PRTNR_NO
                                        ELSE W2.ALNC_PRTNR_DRM_VAL
                                   END AS EMPNO /* 제휴파트너식별값 또는 판매파트너번호 */
                                 , CASE WHEN W1.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020')
                                             THEN 'EMPL' /* 임직원 */
                                        WHEN W1.SELL_PRTNR_NO IN (  '1525290' /*구몬학습*/
                                                                  , '1650501' /*에듀*/
                                                                  , '1564070' /*수학달인*/
                                                                  , '1593484'/*도요새*/
                                                                  , '1712367' /*더퍼스트*/
                                                                 )
                                             THEN 'ENTRPRNR' /* 사업자 */
                                        ELSE 'N'
                                   END EMP_DV
                                 , W1.SELL_PRTNR_NO
                                 , (
                                    SELECT MAX(D1.PRTNR_KNM) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS PRTNR_KNM /* 파트너한글명 */
                                      FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
                                     WHERE D1.PRTNR_NO = W1.SELL_PRTNR_NO
                                     --AND D1.OG_TP_CD = I1.SELL_OG_TP_CD /* 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) TODO:정상적인 마이그레이션이 된다면 이후에 SELL_OG_TP_CD = OG_TP_CD 를 걸어야 됨
                                     GROUP BY D1.PRTNR_NO
                                   ) AS SELL_PRTNR_NM
                                 , W2.ALNC_PRTNR_DRM_VAL /* 제휴파트너식별값 */
                                 , W1.SELL_OG_TP_CD
                                 , W1.CNTR_TP_CD
                                 , W1.CNTR_CNFM_DTM
                                 , W1.IST_DT
                                 , W1.REQD_DT
                                 , W1.CNTR_DTL_STAT_CD
                                 , W1.SELL_INFLW_CHNL_DTL_CD
                                 , W1.BASE_YM
                                 , W1.BASE_YY
                                 , W1.CNTR_NO
                                 , W1.CNTR_SN
                                 , W1.CNTR_PD_STRTDT
                                 , W1.CNTR_PD_ENDDT
                                 , W1.CNTRT_REL_CD
                              FROM W1
                              LEFT OUTER JOIN W2
                                ON W1.CNTR_NO = W2.CNTR_NO
                             WHERE 1=1
                   <if test="@MybatisUtils@isNotEmpty(empNo)">
                               AND W1.SELL_PRTNR_NO = #{empNo}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(cntrtRelCd)">
                               AND W1.CNTRT_REL_CD = #{cntrtRelCd}
                   </if>

                           ) I1
                        LEFT OUTER JOIN LATERAL
                           (
                            SELECT MAX(D1.CRAL_IDV_TNO) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS CRAL_IDV_TNO/* 휴대개별전화번호 */
                                 , MAX(D1.CRAL_LOCARA_TNO) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS CRAL_LOCARA_TNO/* 휴대지역전화번호 */
                                 , MAX(D1.MEXNO_ENCR) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS MEXNO_ENCR/* 휴대전화국번호암호화 */
                                 , MAX(D1.PRTNR_KNM) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS PRTNR_KNM /* 파트너한글명 */
                                 , D1.PRTNR_NO /* 파트너한글명 */
                              FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
                             WHERE D1.PRTNR_NO = I1.EMPNO
                               --AND D1.OG_TP_CD = I1.SELL_OG_TP_CD /* 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) TODO:정상적인 마이그레이션이 된다면 이후에 SELL_OG_TP_CD = OG_TP_CD 를 걸어야 됨
                             GROUP BY D1.PRTNR_NO
                           ) D2
                          ON D2.PRTNR_NO = I1.EMPNO
                     ) I2
                 WHERE 1=1
                 GROUP BY I2.EMPNO, I2.EMP_DV
             ) I3
         WHERE 1=1
             <if test="@MybatisUtils@isNotEmpty(emplDv)">
                 <choose>
                     <when test='@MybatisUtils@equals(emplDv, "1")'> /* 임직원 */
           AND I3.EMP_DV = 'EMPL'
                     </when>
                     <otherwise> /* 사업자 */
           AND I3.EMP_DV = 'ENTRPRNR'
                     </otherwise>
                 </choose>
             </if>
             <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
           AND I3.CRAL_LOCARA_TNO = #{cralLocaraTno}
             </if>
             <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
           AND I3.MEXNO_ENCR = #{mexnoEncr}
             </if>
             <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
           AND I3.CRAL_IDV_TNO = #{cralIdvTno}
             </if>
    </select>

    <select id="selectEmployeePurchases" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaEmployeePrchsGcfMngtDto$SearchCntrRes">
        WITH W3 AS (
        SELECT
               MAX(B1.SELL_PRTNR_NO) AS SELL_PRTNR_NO /* 판매자사번 */
             , MAX(B1.SELL_OG_TP_CD) AS SELL_OG_TP_CD /* 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) */
             , MAX(B1.CNTR_TP_CD) AS CNTR_TP_CD /* 계약유형코드 = '03' 임직원일때 직원구매로 보면 되는지 확인 필요 */
             , MAX(B1.CNTR_CNFM_DTM) AS CNTR_CNFM_DTM /* 계약확정일자 */
             , MAX(C1.IST_DT) AS IST_DT /* 설치일자 */
             , MAX(C1.REQD_DT) AS REQD_DT /* 철거일자 */
             , MAX(A1.CNTR_DTL_STAT_CD) AS CNTR_DTL_STAT_CD /* 301 고객요청해야, 302 연체해약, 303 계약취소 */
             , MAX(B1.SELL_INFLW_CHNL_DTL_CD) AS SELL_INFLW_CHNL_DTL_CD /* 판매유입채널상세코드 9020 일때 직원구매 */
             , TO_CHAR(TRUNC(SYSDATE, 'MM'), 'YYYYMM') AS BASE_YM /* 기준년월 */
             , TO_CHAR(TRUNC(SYSDATE, 'MM'), 'YYYY') AS BASE_YY /* 기준년도 */
             , A1.CNTR_NO
             , A1.CNTR_SN
             , MAX(A1.CNTR_PD_STRTDT) AS CNTR_PD_STRTDT /* 계약상품시작일자 */
             , MAX(A1.CNTR_PD_ENDDT) AS CNTR_PD_ENDDT /* 계약상품종료일자 */
             , CASE WHEN     COUNT(D1.CNTRT_REL_CD) <![CDATA[ > ]]> 1 /* 계약자 관계코드 건수가 1초과(1건 보다 많으면 최종건으로 조회) */
                         AND MAX(D1.VL_END_DTM) != '99991231235959' /* 건수가 여러개고 유효종료일시가 '99991231235959' 가 아니면 */
                         THEN MAX(D1.CNTRT_REL_CD) KEEP (DENSE_RANK FIRST ORDER BY D1.VL_END_DTM DESC NULLS LAST)
                    ELSE MAX(D1.CNTRT_REL_CD)
               END AS CNTRT_REL_CD /* 계약자관계코드 */
             , MAX(B1.CNTR_CST_NO) AS CNTR_CST_NO
             , MAX(A1.BASE_PD_CD) AS BASE_PD_CD
             , MAX(A1.SPP_DUEDT) AS SPP_DUEDT
             , MAX(B1.CNTR_CAN_DTM) AS CNTR_CAN_DTM /*취소일*/
             , MAX(A1.STPL_PTRM) AS STPL_PTRM /*약정기간*/
          FROM TB_SSCT_CNTR_DTL A1  /* 계약상세 */
         INNER JOIN TB_SSCT_CNTR_BAS B1  /* 계약기본 */
            ON B1.CNTR_NO = A1.CNTR_NO
           AND B1.DTA_DL_YN = 'N'
           AND A1.DTA_DL_YN = 'N'
          LEFT OUTER  JOIN TB_SSCT_CNTR_WELLS_DTL C1 /* 계약WELLS상세 - 매출일 렌탈의 경우 설치일자가 매출인식일자로 처리 되므로 INNER로 변경 */
            ON C1.CNTR_NO = A1.CNTR_NO
           AND C1.CNTR_SN = A1.CNTR_SN
           AND C1.DTA_DL_YN = 'N'
           AND A1.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_CST_REL D1 /* T.계약자관계코드 */
            ON D1.DTL_CNTR_NO = A1.CNTR_NO
           AND D1.DTL_CNTR_SN = A1.CNTR_SN
           AND D1.CNTR_CST_REL_TP_CD = '10' /* 계약자 */
           AND D1.DTA_DL_YN = 'N'
         WHERE C1.IST_DT <![CDATA[ >= ]]> #{stYy}||'0101'
           AND A1.SELL_TP_CD = '2'    /* 렌탈 */
           AND C1.IST_DT IS NOT NULL
           AND TO_DATE(C1.IST_DT, 'YYYYMMDD') + 14 <![CDATA[<=]]> SYSDATE
           --AND B1.CNTR_TP_CD = '03' /* 계약유형코드 = '03' 임직원일때 직원구매로 보면 되는지 확인 필요 */
           AND (   B1.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020') /* 1030:정규직원, 1040:계약직원, 9020:직원구매 */
                OR B1.SELL_PRTNR_NO IN (
                                          '1525290' /*구몬학습*/
                                        , '1650501' /*에듀*/
                                        , '1564070' /*수학달인*/
                                        , '1593484' /*도요새*/
                                        , '1712367' /*더퍼스트*/
                                       )
               )
           GROUP BY A1.CNTR_NO, A1.CNTR_SN /* 계약번호, 계약일련번호 GROUP */
        )
        , W4 AS (
        SELECT R.PRTNR_NO /* 파트너번호 */
             , R.ALNC_PRTNR_DRM_VAL /* 제휴파트너 : 제휴파트너식별값 */
             , R.CNTR_NO
         FROM TB_SSCT_CNTR_PRTNR_REL R /* 계약파트너관계 */
        INNER JOIN W3
           ON W3.CNTR_NO = R.CNTR_NO
          AND W3.SELL_PRTNR_NO = R.PRTNR_NO
          AND R.DTA_DL_YN = 'N'
          AND W3.IST_DT BETWEEN R.VL_STRT_DTM AND R.VL_END_DTM
        WHERE 1=1
          AND R.CNTR_PRTNR_TP_CD = '010'
          AND R.ALNC_PRTNR_DRM_VAL != '0'
          AND R.PRTNR_NO IN (
                               '1525290' /*구몬학습*/
                             , '1650501' /*에듀*/
                             , '1564070' /*수학달인*/
                             , '1593484'/*도요새*/
                             , '1712367' /*더퍼스트*/
                            )
        GROUP BY R.PRTNR_NO /* 파트너번호 */
               , R.ALNC_PRTNR_DRM_VAL /* 제휴파트너 : 제휴파트너식별값 */
               , R.CNTR_NO /* 계약번호 */
        )
        SELECT I1.HMNRSC_EMPNO /* 판매자사번 */
             , I1.PRTNR_KNM /* 판매자명 */
             , I1.OG_NM /* 조직명-판매자소속 */
             , I1.CNTR_DTL_NO /* 계약번호 */
             , I1.CST_KNM /* 고객명 */
             , I1.BRYY_MMDD /* 고객생년월일 */
             , I1.PD_NM /* 상품명 */
             , I1.PD_TP_CD /* 상품유형 */
             , I1.CNTR_CNFM_DTM /* 계약확정일시 - 접수일 */
             , I1.SPP_DUEDT /* 배송예정일자 - 예정일 */
             , I1.IST_DT /* 설치일 */
             , I1.CNTR_CAN_DTM /* 취소일 */
             , I1.STPL_PTRM /* 약정기간 */
        --     , I1.EMP_DV
        --     , I1.SELL_PRTNR_NO
        --     , I1.ALNC_PRTNR_DRM_VAL
        --     , I1.SELL_OG_TP_CD
        --     , I1.CNTR_TP_CD
        --     , I1.REQD_DT
        --     , I1.CNTR_DTL_STAT_CD
        --     , I1.SELL_INFLW_CHNL_DTL_CD
        --     , I1.BASE_YM
        --     , I1.BASE_YY
        --     , I1.CNTR_NO
        --     , I1.CNTR_SN
        --     , I1.CNTR_PD_STRTDT
        --     , I1.CNTR_PD_ENDDT
        --     , I1.CNTRT_REL_CD
          FROM
             (
              SELECT
                     NVL(W4.ALNC_PRTNR_DRM_VAL, W3.SELL_PRTNR_NO) AS HMNRSC_EMPNO /* 제휴파트너식별값 또는 판매파트너번호 */
                   , (
                      SELECT MAX(D1.PRTNR_KNM) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS PRTNR_KNM /* 파트너한글명 */
                        FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
                       WHERE D1.PRTNR_NO = NVL(W4.ALNC_PRTNR_DRM_VAL, W3.SELL_PRTNR_NO)
        --                 AND D1.OG_TP_CD = W1.SELL_OG_TP_CD /* 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) TODO:정상적인 마이그레이션이 된다면 이후에 SELL_OG_TP_CD = OG_TP_CD 를 걸어야 됨 */
                       GROUP BY D1.PRTNR_NO
                     ) AS PRTNR_KNM
                   , CASE WHEN W3.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020')
                               THEN
                                    (
                                     SELECT MAX(F1.OG_NM) /* 조직명 */
                                       FROM TB_OGBS_MM_PRTNR_IZ F1 /* 월파트너내역 */
                                      WHERE F1.PRTNR_NO = W3.SELL_PRTNR_NO /* 제휴파트너식별값(ALNC_PRTNR_DRM_VAL)로 대체 된 경우 조회되지 않음 */
                                        AND F1.BASE_YM = SUBSTR(W3.CNTR_CNFM_DTM, 1, 6)
                                        AND F1.DTA_DL_YN = 'N'
                                        --AND F1.OG_TP_CD = I1.SELL_OG_TP_CD /* 20230728 확인시 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) */
                                    )
                          WHEN W3.SELL_PRTNR_NO IN (  '1525290' /* 구몬학습*/
                                                    , '1650501' /* 에듀*/
                                                    , '1564070' /* 수학달인*/
                                                    , '1593484' /* 도요새*/
                                                    , '1712367' /* 더퍼스트*/
                                                   )
                               THEN
                                    (
                                     SELECT MAX(D1.PRTNR_KNM) KEEP (DENSE_RANK FIRST ORDER BY NVL(D1.FNL_MDFC_DTM, D1.FST_RGST_DTM) ASC NULLS LAST) AS PRTNR_KNM /* 파트너한글명 */
                                       FROM TB_OGBS_PRTNR_BAS D1 /* 파트너기본 */
                                      WHERE D1.PRTNR_NO = W3.SELL_PRTNR_NO
                                       -- AND D1.OG_TP_CD = W1.SELL_OG_TP_CD /* 계약기본.판매조직유형코드가 정상적으로 들어있지 않음(EX] @1650, @1564...) TODO:정상적인 마이그레이션이 된다면 이후에 SELL_OG_TP_CD = OG_TP_CD 를 걸어야 됨 */
                                      GROUP BY D1.PRTNR_NO
                                    )
                          ELSE ''
                     END AS OG_NM
                   , W3.CNTR_NO || '-' || W3.CNTR_SN AS CNTR_DTL_NO /*계약번호*/
                   , T8.CST_KNM /*고객명*/
                   , T8.BRYY_MMDD /*고객 생년월일*/
                   , T9.PD_NM /*상품명*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'PD_TP_CD', T9.PD_TP_CD) AS PD_TP_CD /*상품유형*/
                   , W3.CNTR_CNFM_DTM
                   , W3.SPP_DUEDT
                   , W3.IST_DT
                   , W3.CNTR_PD_ENDDT AS CNTR_CAN_DTM /* 취소일 계약상세 상품종료일로 대체 */
                   , W3.STPL_PTRM
                   , CASE WHEN W3.SELL_INFLW_CHNL_DTL_CD IN ('1030','1040','9020')
                               THEN 'EMPL' /* 임직원 */
                          WHEN W3.SELL_PRTNR_NO IN (  '1525290' /* 구몬학습*/
                                                    , '1650501' /* 에듀*/
                                                    , '1564070' /* 수학달인*/
                                                    , '1593484' /* 도요새*/
                                                    , '1712367' /* 더퍼스트*/
                                                   )
                               THEN 'ENTRPRNR' /* 사업자 */
                          ELSE 'N'
                     END EMP_DV
                   , W3.SELL_PRTNR_NO
                   , W4.ALNC_PRTNR_DRM_VAL /* 제휴파트너식별값 */
                   , W3.SELL_OG_TP_CD
                   , W3.CNTR_TP_CD
                   , W3.REQD_DT
                   , W3.CNTR_DTL_STAT_CD
                   , W3.SELL_INFLW_CHNL_DTL_CD
                   , W3.BASE_YM
                   , W3.BASE_YY
                   , W3.CNTR_NO
                   , W3.CNTR_SN
                   , W3.CNTR_PD_STRTDT
                   , W3.CNTR_PD_ENDDT
                   , W3.CNTRT_REL_CD
                FROM W3
                LEFT OUTER JOIN W4
                  ON W3.CNTR_NO = W4.CNTR_NO
                LEFT OUTER JOIN TB_CUBS_CST_BAS T8 /*고객기본*/
                  ON T8.CST_NO = W3.CNTR_CST_NO
                 AND T8.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_PDBS_PD_BAS T9 /*상품기본*/
                  ON T9.PD_CD = W3.BASE_PD_CD
                 AND T9.DTA_DL_YN = 'N'
               WHERE 1=1
                 AND NVL(W4.ALNC_PRTNR_DRM_VAL, W3.SELL_PRTNR_NO) = #{empno}
             )I1
         WHERE 1=1
        <choose>
            <when test='@MybatisUtils@equals(colDv, "pre")'> /* 월구분이 전월(pre)이면서, */
                <if test='@MybatisUtils@isEmpty(srchGbn)'> /* 설치구분이 없으면,(=설치이면,) */
           AND I1.IST_DT BETWEEN #{stYy}||'0101' AND TO_CHAR(LAST_DAY(ADD_MONTHS(SYSDATE, -1)), 'YYYYMMDD')
                </if>
                <if test='@MybatisUtils@equals(srchGbn, "cncl")'> /* 설치구분이 취소(cncl)이면, */
           AND I1.IST_DT <![CDATA[>=]]> #{stYy}||'0101'
           AND SUBSTR(I1.IST_DT, 1, 6) <![CDATA[<]]> TO_CHAR(TRUNC(SYSDATE, 'MM'), 'YYYYMM')
           AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
           AND I1.CNTR_PD_ENDDT BETWEEN #{stYy}||'0101' AND TO_CHAR(LAST_DAY(ADD_MONTHS(SYSDATE, -1)), 'YYYYMMDD')
                </if>
                <if test='@MybatisUtils@equals(srchGbn, "fnl")'> /* 설치구분이 최종(fnl)이면, */
           AND I1.IST_DT BETWEEN #{stYy}||'0101' AND TO_CHAR(LAST_DAY(ADD_MONTHS(SYSDATE, -1)), 'YYYYMMDD')
           AND I1.CNTR_DTL_STAT_CD NOT IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
           AND I1.CNTR_PD_ENDDT NOT BETWEEN #{stYy}||'0101' AND TO_CHAR(LAST_DAY(ADD_MONTHS(SYSDATE, -1)), 'YYYYMMDD')
                </if>
            </when>
            <when test='@MybatisUtils@equals(colDv, "tot")'> /* 월구분이 전체(tot) */
           AND I1.IST_DT BETWEEN #{stYy}||'0101' AND #{stYy}||'1231'
           AND I1.CNTR_DTL_STAT_CD NOT IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
            </when>
            <otherwise>
                <if test='@MybatisUtils@isEmpty(srchGbn)'> /* 설치구분이 없으면,(=설치이면,) */
           AND I1.IST_DT BETWEEN #{stYy}||#{colDv}||'01' AND TO_CHAR(LAST_DAY(#{stYy}||#{colDv}||'01'), 'YYYYMMDD')
                </if>
                <if test='@MybatisUtils@equals(srchGbn, "cncl")'> /* 설치구분이 취소(cncl)이면, */
           AND I1.IST_DT BETWEEN #{stYy}||#{colDv}||'01' AND TO_CHAR(LAST_DAY(#{stYy}||#{colDv}||'01'), 'YYYYMMDD')
           AND I1.CNTR_DTL_STAT_CD IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
           AND I1.CNTR_PD_ENDDT BETWEEN #{stYy}||#{colDv}||'01' AND TO_CHAR(LAST_DAY(#{stYy}||#{colDv}||'01'), 'YYYYMMDD')
                </if>
                <if test='@MybatisUtils@equals(srchGbn, "fnl")'> /* 설치구분이 최종(fnl)이면, */
           AND I1.IST_DT BETWEEN #{stYy}||#{colDv}||'01' AND TO_CHAR(LAST_DAY(#{stYy}||#{colDv}||'01'), 'YYYYMMDD')
           AND I1.CNTR_DTL_STAT_CD NOT IN ('301', '302', '303') /* 301:고객요청해약, 302:연체해약, 303:계약취소 */
           AND I1.CNTR_PD_ENDDT NOT BETWEEN #{stYy}||#{colDv}||'01' AND TO_CHAR(LAST_DAY(#{stYy}||#{colDv}||'01'), 'YYYYMMDD')
                </if>
            </otherwise>
        </choose>
         ORDER BY I1.IST_DT
    </select>
</mapper>
