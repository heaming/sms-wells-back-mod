<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.salesstatus.mapper.WcteSecProductMapper">
    <!-- region 예약일 -->
    <select id="selectReservationPages"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchReservationRes">
        SELECT T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_NO        AS CNTR_NO /*계약번호*/
             , T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_SN        AS CNTR_SN /*계약일련번호*/
             , T_SPP_BZS_ULD_HIST_BOOKING.BSDT               AS RES_DT /* 예약일시 */
             , T_SPP_BZS_ULD_HIST_STOC_STR.BSDT              AS STOC_STR_DT /* 재입고일시 */
             , T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.SPP_BZS_ORD_ID AS SPP_BZS_ORD_ID /*배송업체주문ID*/
             , T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.FST_RGST_DTM   AS FST_RGST_DTM /*최초등록일시*/
             , T_CNTR_DTL.SELL_TP_CD                         AS SELL_TP_CD /*판매유형코드*/
             , T_CNTR_DTL.BASE_PD_CD                         AS PD_CD /*기준상품코드*/
             , T_PD_BAS.PD_NM                                AS PD_NM /*기준상품명*/
             , T_CNTR_ADRPC_BAS.RCGVP_KNM                    AS RCGVP_KNM /*수령자한글명*/
             , T_CNTR_BAS.SELL_PRTNR_NO                      AS SELL_PRTNR_NO /*판매파트너번호*/
             , T_CNTR_BAS.CNTR_CNFM_DTM                      AS CNTR_CNFM_DTM /*계약확정일시*/
             , T_CNTR_PRTNR_REL.OG_TP_CD                     AS OG_TP_CD /*조직유형코드*/
             , T_MM_OG_IZ.OG_ID                              AS OG_ID /*조직ID*/
             , T_MM_OG_IZ.OG_CD                              AS OG_CD /*조직코드*/
             , T_MM_OG_IZ.HOO_PRTNR_NO                       AS HOO_PRTNR_NO /*조직장파트너번호*/
             , T_MM_PRTNR_IZ.PRTNR_KNM                       AS PRTNR_KNM /*파트너한글명*/
          FROM (SELECT CNTR_NO
                     , CNTR_SN
                     , MAX(FST_RGST_DTM)   AS FST_RGST_DTM
                     , MAX(SPP_BZS_ORD_ID) AS SPP_BZS_ORD_ID /* 다른 행의 데이터가 조회 될 수도 있지만 현재는 그런 값이 없다.*/
                  FROM TB_SSOP_SPP_BZS_ULD_HIST /*배송업체업로드이력*/
                 WHERE DTA_DL_YN = 'N'
                   AND SPP_PROCS_BZS_CD = '3' /* 삼성전자 */
                   AND SPP_BZS_MNGT_ATC_CD IN ('10', '20') /* 예정일자 혹은 재고 입고 일자, 재고 입고 일자만 있는 계약도 가져온다. */
                 GROUP BY CNTR_NO
                        , CNTR_SN)                      T_SPP_BZS_ULD_HIST_GRP_BY_CNTR /*계약 최신 이력*/
               LEFT OUTER JOIN TB_SSOP_SPP_BZS_ULD_HIST T_SPP_BZS_ULD_HIST_BOOKING /*예약 이력*/
               ON T_SPP_BZS_ULD_HIST_BOOKING.DTA_DL_YN = 'N'
                   AND T_SPP_BZS_ULD_HIST_BOOKING.CNTR_NO = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_NO
                   AND T_SPP_BZS_ULD_HIST_BOOKING.CNTR_SN = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_SN
                   AND T_SPP_BZS_ULD_HIST_BOOKING.SPP_PROCS_BZS_CD = '3' /* 삼성 */
                   AND T_SPP_BZS_ULD_HIST_BOOKING.SPP_BZS_MNGT_ATC_CD = '10' /* 예정일자 */
               LEFT OUTER JOIN TB_SSOP_SPP_BZS_ULD_HIST T_SPP_BZS_ULD_HIST_STOC_STR /*재고 입고 이력*/
               ON T_SPP_BZS_ULD_HIST_BOOKING.DTA_DL_YN = 'N'
                   AND T_SPP_BZS_ULD_HIST_BOOKING.CNTR_NO = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_NO
                   AND T_SPP_BZS_ULD_HIST_BOOKING.CNTR_SN = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_SN
                   AND T_SPP_BZS_ULD_HIST_BOOKING.SPP_PROCS_BZS_CD = '3' /* 삼성 */
                   AND T_SPP_BZS_ULD_HIST_BOOKING.SPP_BZS_MNGT_ATC_CD = '20' /* 재고입고일자 */
               INNER JOIN TB_SSCT_CNTR_DTL              T_CNTR_DTL /*계약상세*/
               ON T_CNTR_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_DTL.CNTR_NO = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_NO
                   AND T_CNTR_DTL.CNTR_SN = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_SN
                   AND T_CNTR_DTL.SELL_TP_CD IN ('1', '2')
               INNER JOIN TB_SSCT_CNTR_BAS              T_CNTR_BAS /*계약기본*/
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               INNER JOIN TB_SSCT_CNTR_ADR_REL          T_CNTR_ADR_REL /*계약주소관계*/
               ON T_CNTR_ADR_REL.DTA_DL_YN = 'N'
                   AND T_CNTR_ADR_REL.DTL_CNTR_NO = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_NO
                   AND T_CNTR_ADR_REL.DTL_CNTR_SN = T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.CNTR_SN
                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T_CNTR_ADR_REL.VL_STRT_DTM AND T_CNTR_ADR_REL.VL_END_DTM
                   AND T_CNTR_ADR_REL.ADRPC_TP_CD IN ('2','3') /* 주소지 유형 코드: 2.배달주소, 3.설치주소*/
               INNER JOIN TB_SSCT_CNTR_ADRPC_BAS        T_CNTR_ADRPC_BAS /*계약주소지기본*/
               ON T_CNTR_ADRPC_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_ADRPC_BAS.CNTR_ADRPC_ID = T_CNTR_ADR_REL.CNTR_ADRPC_ID
               LEFT OUTER JOIN TB_SSCT_CNTR_PRTNR_REL   T_CNTR_PRTNR_REL /*계약파트너관계 FIXME INNER*/
               ON T_CNTR_PRTNR_REL.DTA_DL_YN = 'N'
                   AND T_CNTR_PRTNR_REL.CNTR_PRTNR_TP_CD = '010' /*판매자*/
                   AND T_CNTR_PRTNR_REL.CNTR_NO = T_CNTR_BAS.CNTR_NO
                   AND T_CNTR_PRTNR_REL.PRTNR_NO = T_CNTR_BAS.SELL_PRTNR_NO
               INNER JOIN TB_PDBS_PD_BAS                T_PD_BAS /*상품기본*/
               ON T_PD_BAS.DTA_DL_YN = 'N'
                   AND T_PD_BAS.PD_CD = T_CNTR_DTL.BASE_PD_CD
               LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ      T_MM_PRTNR_IZ /*월파트너내역*/
               ON T_MM_PRTNR_IZ.DTA_DL_YN = 'N'
                   AND T_MM_PRTNR_IZ.OG_TP_CD = T_CNTR_PRTNR_REL.OG_TP_CD
                   AND T_MM_PRTNR_IZ.BASE_YM = SUBSTR(T_CNTR_BAS.CNTR_CNFM_DTM, 1, 6)
                   AND T_MM_PRTNR_IZ.PRTNR_NO = T_CNTR_BAS.SELL_PRTNR_NO
               LEFT OUTER JOIN TB_OGBS_MM_OG_IZ         T_MM_OG_IZ /*월조직내역*/
               ON T_MM_OG_IZ.DTA_DL_YN = 'N'
                   AND T_MM_OG_IZ.BASE_YM = SUBSTR(T_CNTR_BAS.CNTR_CNFM_DTM, 1, 6)
                   AND T_MM_PRTNR_IZ.OG_ID = T_MM_OG_IZ.OG_ID
          <where>
              <if test="@MybatisUtils@isNotEmpty(sellTpCd)"><trim>
                  AND T_CNTR_DTL.SELL_TP_CD = #{sellTpCd}
              </trim></if>
              <if test="@MybatisUtils@isNotEmpty(strtdt) and @MybatisUtils@isNotEmpty(enddt)"><trim>
                  AND ((T_SPP_BZS_ULD_HIST_BOOKING.BSDT BETWEEN #{strtdt} AND #{enddt}) OR
                  (T_SPP_BZS_ULD_HIST_STOC_STR.BSDT BETWEEN #{strtdt} AND #{enddt}))
              </trim></if>
          </where>
         ORDER BY T_SPP_BZS_ULD_HIST_GRP_BY_CNTR.FST_RGST_DTM
    </select>
    <!-- endregion 예약일 -->

    <!-- region 확정일 -->
    <select id="selectConfirms"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchConfirmRes">
        SELECT T_BZS_IVC_PROCS_IZ.CNTR_NO           AS CNTR_NO /*계약번호 orderSheetId*/
             , T_BZS_IVC_PROCS_IZ.CNTR_SN           AS CNTR_SN /*계약일련번호*/
             , T_CNTR_DTL.SELL_TP_CD                AS SELL_TP_CD /*판매유형코드 LCTYPE*/
             , T_CNTR_DTL.PD_HCLSF_ID               AS PD_HCLSF_ID /*상품대분류ID KAETC1*/
             , T_CNTR_DTL.PD_MCLSF_ID               AS PD_MCLSF_ID /*상품중분류ID KAETC2*/
             , T_CNTR_ADRPC_BAS.RCGVP_KNM           AS RCGVP_KNM /*수령자한글명 LCCNAM*/
             , T_BZS_IVC_PROCS_IZ.SPP_BZS_ORD_ID    AS SPP_BZS_ORD_ID /*배송업체주문ID ORDER_DELIVERY_ID*/
             , T_BZS_IVC_PROCS_IZ.SPP_FSH_DT        AS SPP_FSH_DT /*배송완료일자 DELIVERY_END_DT*/
             , T_CNTR_DTL.BASE_PD_CD                AS PD_CD /*기준상품코드 LCICDE*/
             , T_PD_BAS.PD_NM                       AS PD_NM /*상품명 productSName*/
             , T_BZS_IVC_PROCS_IZ.SPP_FSH_RGST_DTM  AS SPP_FSH_RGST_DTM /*배송완료등록일시 DE_END_DT_REGDTTM*/
             , T_BZS_IVC_PROCS_IZ.BAT_WK_FSH_DTM    AS BAT_WK_FSH_DTM /*배치작업완료일시 DE_END_DT_RSLT1_DTTM*/
             , T_CNTR_DTL_STAT_CH_HIST.CAN_DT       AS CAN_DT /*취소일 LCCANY*/
             , T_CTT_BAS.CTT_RS_CD                  AS CTT_RS_CD /*컨택결과코드 LCCCDE*/
             , T_PDCT_IDNO_OSTR_IZ.PDCT_IDNO        AS PDCT_IDNO /*제품고유번호 LCSRNO*/
             , T_PDCT_IDNO_OSTR_IZ.SPP_BZS_MODEL_ID AS SPP_BZS_MODEL_ID /*배송업체모델ID LCSRN1*/
             , CASE
                   WHEN T_CNTR_DTL.SELL_TP_CD != '2' THEN ''
                   WHEN (T_CNTR_DTL.CNTR_AMT - T_CNTR_PRC_CMPT_IZ.CTR_VAL) = 0
                                                     THEN ''
                   WHEN (T_CNTR_DTL.CNTR_AMT - T_CNTR_PRC_CMPT_IZ.CTR_VAL) <![CDATA[<=]]> (SELECT SUM(CASE
                                                                                                 WHEN DP_DV_CD = '1'
                                                                                                     THEN RVE_AMT
                                                                                                     ELSE RVE_AMT * -1
                                                                                             END)
                                                                                    FROM TB_RVDW_RVE_DTL /*수납상세*/
                                                                                   WHERE DTA_DL_YN = 'N'
                                                                                     AND CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                                                                                     AND CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN)
                                                     THEN 'Y'
                                                     ELSE 'N'
               END                                  AS RGST_FEE_FLPYM_YN /*등록비완납여부 TRMT_CMPL_YN*/
          FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ              T_BZS_IVC_PROCS_IZ /*배송업체송장처리내역*/
               LEFT OUTER JOIN TB_SSCT_CNTR_DTL          T_CNTR_DTL /*계약상세*/
               ON T_CNTR_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_DTL.CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_CNTR_DTL.CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
               INNER JOIN TB_SSCT_CNTR_BAS               T_CNTR_BAS /*계약기본*/
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL      T_CNTR_ADR_REL /*계약주소관계*/
               ON T_CNTR_ADR_REL.DTA_DL_YN = 'N'
                   AND T_CNTR_ADR_REL.DTL_CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_CNTR_ADR_REL.DTL_CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T_CNTR_ADR_REL.VL_STRT_DTM || '000000' AND
                       T_CNTR_ADR_REL.VL_END_DTM || '235959'
                   AND T_CNTR_ADR_REL.ADRPC_TP_CD IN ('2','3') /* 주소지 유형 코드: 2.배달주소, 3.설치주소*/
               LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS    T_CNTR_ADRPC_BAS /*계약주소지기본*/
               ON T_CNTR_ADRPC_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_ADRPC_BAS.CNTR_ADRPC_ID = T_CNTR_ADR_REL.CNTR_ADRPC_ID
                   AND T_CNTR_ADRPC_BAS.CNTR_NO = T_CNTR_ADR_REL.DTL_CNTR_NO
               LEFT OUTER JOIN TB_SSOP_CTT_DTL           T_CTT_DTL
               ON T_CTT_DTL.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CTT_DTL.CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND T_CTT_DTL.CTT_OJ_ID = (SELECT MAX(CTT_OJ_ID)
                                                FROM TB_SSOP_CTT_DTL
                                               WHERE DTA_DL_YN = 'N'
                                                 AND CNTR_NO = T_CTT_DTL.CNTR_NO
                                                 AND CNTR_SN = T_CTT_DTL.CNTR_SN)
               LEFT OUTER JOIN TB_SSOP_CTT_BAS           T_CTT_BAS
               ON T_CTT_BAS.CTT_OJ_ID = T_CTT_DTL.CTT_OJ_ID
               LEFT OUTER JOIN (SELECT CNTR_NO, CNTR_SN, CAN_DT
                                  FROM (SELECT CNTR_NO
                                             , CNTR_SN
                                             , SUBSTR(HIST_STRT_DTM, 1, 8)                                                   AS CAN_DT
                                             , ROW_NUMBER() OVER (PARTITION BY CNTR_NO, CNTR_SN ORDER BY HIST_STRT_DTM DESC) AS RN
                                          FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST
                                         WHERE DTA_DL_YN = 'N'
                                           AND CNTR_DTL_STAT_CD IN ('301', '302', '303'))
                                 WHERE RN = 1)           T_CNTR_DTL_STAT_CH_HIST
               ON T_CNTR_DTL_STAT_CH_HIST.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_DTL_STAT_CH_HIST.CNTR_SN = T_CNTR_DTL.CNTR_SN
               LEFT OUTER JOIN TB_SSSO_PDCT_IDNO_OSTR_IZ T_PDCT_IDNO_OSTR_IZ /*제품고유번호출고내역*/
               ON T_PDCT_IDNO_OSTR_IZ.DTA_DL_YN = 'N'
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
               LEFT OUTER JOIN TB_SSCT_CNTR_PRC_CMPT_IZ  T_CNTR_PRC_CMPT_IZ /*계약가격산출내역*/
               ON T_CNTR_PRC_CMPT_IZ.DTA_DL_YN = 'N'
                   AND T_CNTR_PRC_CMPT_IZ.CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_CNTR_PRC_CMPT_IZ.CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
               LEFT OUTER JOIN TB_PDBS_PD_BAS            T_PD_BAS /*상품기본*/
               ON T_PD_BAS.DTA_DL_YN = 'N'
                   AND T_PD_BAS.PD_CD = T_CNTR_DTL.BASE_PD_CD
               INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL        T_PD_ECOM_PRP_DTL /*상품각사속성안내*/
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_CNTR_DTL.BASE_PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP'
                   AND T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S'
         WHERE T_CNTR_DTL.SELL_TP_CD IN ('1', '2')
           <if test="@MybatisUtils@isNotEmpty(strtdt) and @MybatisUtils@isNotEmpty(enddt)"><trim>
               AND T_BZS_IVC_PROCS_IZ.SPP_FSH_DT BETWEEN #{strtdt} AND #{enddt}
           </trim></if>
           AND T_BZS_IVC_PROCS_IZ.SPP_BZS_ORD_ID IS NOT NULL
           <if test="@MybatisUtils@isNotEmpty(sellTpCd)"><trim>
               AND T_CNTR_DTL.SELL_TP_CD = #{sellTpCd}
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(sppBzsOrdId)"><trim>
               AND T_BZS_IVC_PROCS_IZ.SPP_BZS_ORD_ID LIKE '%' || #{sppBzsOrdId} || '%'
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(pdctIdno)"><trim>
               AND T_PDCT_IDNO_OSTR_IZ.PDCT_IDNO LIKE '%' || UPPER(#{pdctIdno}) || '%'
           </trim></if>
         ORDER BY T_BZS_IVC_PROCS_IZ.SPP_FSH_DT DESC

    </select>

    <select id="selectConfirmValidation"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dvo.WcteConfirmValidationDvo"
    >
        SELECT T_CNTR_DTL.CNTR_NO                   AS CNTR_NO /*계약번호*/
             , T_CNTR_DTL.CNTR_SN                   AS CNTR_SN /*계약일련번호*/
             , T_CNTR_DTL.SELL_TP_CD                   AS SELL_TP_CD /* 계약종류 */
             , T_CNTR_DTL_STAT_CANCELED_HIST.CAN_DT AS CAN_DT /*취소일자*/
             , CASE
                   WHEN T_CNTR_DTL.CNTR_PD_STRTDT IS NOT NULL /*60:확정*/
                       THEN 'Y'
                       ELSE ''
               END                                  AS CNTR_CNFM_YN /*매출확정여부*/
             , T_CNTR_WELLS_DTL.IST_DT              AS IST_DT /*설치일자*/
             , T_CNTR_DTL.SPP_DUEDT                 AS SPP_DUEDT /*배송예정일자*/
             , T_CNTR_WELLS_DTL.CPS_DT              AS CPS_DT /*보상일자*/
             , CASE
                   WHEN T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S'
                       THEN 'Y'
                       ELSE ''
               END                                  AS SEC_PD_YN /*삼성제품여부*/
             , CASE
                   WHEN T_PDCT_IDNO_OSTR_IZ.OSTR_SN IS NOT NULL
                       THEN 'Y'
                       ELSE ''
               END                                  AS OSTR_RGST_YN /*제품고유번호출고내역존재여부*/
          FROM TB_SSCT_CNTR_DTL                          T_CNTR_DTL /*계약상세*/
               INNER JOIN TB_SSCT_CNTR_BAS               T_CNTR_BAS /*계약기본*/
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               LEFT OUTER JOIN (SELECT CNTR_NO, CNTR_SN, CAN_DT
                                  FROM (SELECT CNTR_NO
                                             , CNTR_SN
                                             , SUBSTR(HIST_STRT_DTM, 1, 8)                                                   AS CAN_DT
                                             , ROW_NUMBER() OVER (PARTITION BY CNTR_NO, CNTR_SN ORDER BY HIST_STRT_DTM DESC) AS RN
                                          FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST
                                         WHERE DTA_DL_YN = 'N'
                                           AND CNTR_DTL_STAT_CD IN ('301', '302', '303'))
                                 WHERE RN = 1)           T_CNTR_DTL_STAT_CANCELED_HIST
               ON T_CNTR_DTL_STAT_CANCELED_HIST.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_DTL_STAT_CANCELED_HIST.CNTR_SN = T_CNTR_DTL.CNTR_SN
               LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL    T_CNTR_WELLS_DTL /*계약WELLS상세*/
               ON T_CNTR_WELLS_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_WELLS_DTL.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_WELLS_DTL.CNTR_SN = T_CNTR_DTL.CNTR_SN
               LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL        T_PD_ECOM_PRP_DTL /*상품각사속성안내*/
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_CNTR_DTL.BASE_PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP'
               LEFT OUTER JOIN TB_SSSO_PDCT_IDNO_OSTR_IZ        T_PDCT_IDNO_OSTR_IZ /*제품고유번호출고내역*/
               ON T_PDCT_IDNO_OSTR_IZ.DTA_DL_YN = 'N'
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND T_PDCT_IDNO_OSTR_IZ.OSTR_SN = '0'
         WHERE T_CNTR_DTL.DTA_DL_YN = 'N'
           AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
           AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
    </select>

    <update id="updateShippingDueDate">
        update TB_SSCT_CNTR_DTL T_CNTR_DTL
           set T_CNTR_DTL.SPP_DUEDT = #{sppDuedt}
        <include refid="COMMON.updateSystemField"/>
         where T_CNTR_DTL.DTA_DL_YN = 'N'
           AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
           AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
    </update>

    <insert id="insertContractDetailChangeHistory">
        INSERT INTO TB_SSCT_CNTR_DCH_HIST ( CNTR_NO /*계약번호*/
                                          , CNTR_SN /*계약일련번호*/
                                          , HIST_STRT_DTM /*이력시작일시*/
                                          , HIST_END_DTM /*이력종료일시*/
                                          , BASE_PD_CD /*기준상품코드*/
                                          , HGR_PD_CD /*상위상품코드*/
                                          , PD_QTY /*상품수량*/
                                          , STPL_PTRM_UNIT_CD /*약정기간단위코드*/
                                          , STPL_PTRM /*약정기간*/
                                          , ISTM_MCN /*할부개월수*/
                                          , CNTR_PD_STRTDT /*계약상품시작일자*/
                                          , CNTR_PD_ENDDT /*계약상품종료일자*/
                                          , CNTR_DTL_STAT_CD /*계약상세상태코드*/
                                          , SELL_TP_CD /*판매유형코드*/
                                          , SV_PTRM_UNIT_CD /*서비스기간단위코드*/
                                          , SV_PRD /*서비스주기*/
                                          , BLG_CRP_CD /*소속법인코드*/
                                          , RVE_CRP_CD /*수납법인코드*/
                                          , CO_CD /*회사코드*/
                                          , PD_GD_CD /*상품등급코드*/
                                          , PD_HCLSF_ID /*상품대분류ID*/
                                          , PD_MCLSF_ID /*상품중분류ID*/
                                          , PD_LCLSF_ID /*상품소분류ID*/
                                          , PD_DCLSF_ID /*상품세분류ID*/
                                          , STLM_TP_CD /*결제유형코드*/
                                          , CRNCY_DV_CD /*통화구분코드*/
                                          , APY_EXCR /*적용환율*/
                                          , PD_BASE_AMT /*상품기준금액*/
                                          , FNL_AMT /*최종금액*/
                                          , VAT /*부가가치세*/
                                          , SELL_AMT /*판매금액*/
                                          , CNTR_AMT /*계약금액*/
                                          , ISTM_PCAM_AMT /*할부원금금액*/
                                          , ISTM_INT_AMT /*할부이자금액*/
                                          , MM_ISTM_AMT /*월할부금액*/
                                          , ACKMT_PERF_RT /*인정실적율*/
                                          , ACKMT_PERF_AMT /*인정실적금액*/
                                          , SPP_DUEDT /*배송예정일자*/
                                          , RESUB_YN /*재구독여부*/
                                          , RSTL_YN /*재약정여부*/
                                          , FRISU_YN /*무상여부*/
                                          , SMTPL_ID /*스마트플랜ID*/
                                          , SMTPL_SN /*스마트플랜일련번호*/
                                          , BF_ORD_NO /*이전주문번호*/
                                          , CNTR_CH_RCP_ID /*계약변경접수ID*/
                                          , CNTR_CH_SN /*계약변경일련번호*/
                                          , DTA_DL_YN /*데이터삭제여부*/
                                          , FST_RGST_DTM /*최초등록일시*/
                                          , FST_RGST_USR_ID /*최초등록사용자ID*/
                                          , FST_RGST_PRG_ID /*최초등록프로그램ID*/
                                          , FST_RGST_DEPT_ID /*최초등록부서ID*/
                                          , FNL_MDFC_DTM /*최종수정일시*/
                                          , FNL_MDFC_USR_ID /*최종수정사용자ID*/
                                          , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
                                          , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
                                          , BOO_SELL_TP_CD /*예약판매유형코드*/
                                          , FEE_FXAM_YN /*수수료정액여부*/
                                          , FRISU_DSB_TP_CD /*무상지급유형코드*/
                                          , CNTR_CH_DTL_AK_CN /*계약변경상세요청내용*/
                                          , CNTRW_TP_CD /*계약서유형코드*/
                                          , TXINV_PBL_OJ_YN /*세금계산서발행대상여부*/
                                          , FEE_ACKMT_CT /*수수료인정건수*/
                                          , CVT_PERF_AMT /*환산실적금액*/
                                          , FEE_ACKMT_BASE_AMT /*수수료인정기준금액*/
                                          , SELL_TP_DTL_CD /*판매유형상세코드*/
                                          , SELL_DSC_DV_CD /*판매할인구분코드*/
                                          , SELL_DSCR_CD /*판매할인율코드*/
                                          , SELL_DSC_CTR_AMT /*판매할인조정금액*/
                                          , SELL_DSC_TP_CD /*판매할인유형코드*/
                                          , DSC_AMT /*할인금액*/
                                          , CNTRAM_DSC_AMT /*계약금할인금액*/
                                          , CRP_UC_AMT /*법인미수금액*/
                                          , SELL_FEE /*판매수수료*/
                                          , ALNCMP_CD /*제휴사코드*/
                                          , ALNCMP_CNTR_DRM_VAL /*제휴사계약식별값*/
        )
        SELECT CNTR_NO /*계약번호*/
             , CNTR_SN /*계약일련번호*/
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS HIST_STRT_DTM
             , '99991231235959'                     AS HIST_END_DTM
             , BASE_PD_CD /*기준상품코드*/
             , HGR_PD_CD /*상위상품코드*/
             , PD_QTY /*상품수량*/
             , STPL_PTRM_UNIT_CD /*약정기간단위코드*/
             , STPL_PTRM /*약정기간*/
             , ISTM_MCN /*할부개월수*/
             , CNTR_PD_STRTDT /*계약상품시작일자*/
             , CNTR_PD_ENDDT /*계약상품종료일자*/
             , CNTR_DTL_STAT_CD /*계약상세상태코드*/
             , SELL_TP_CD /*판매유형코드*/
             , SV_PTRM_UNIT_CD /*서비스기간단위코드*/
             , SV_PRD /*서비스주기*/
             , BLG_CRP_CD /*소속법인코드*/
             , RVE_CRP_CD /*수납법인코드*/
             , CO_CD /*회사코드*/
             , PD_GD_CD /*상품등급코드*/
             , PD_HCLSF_ID /*상품대분류ID*/
             , PD_MCLSF_ID /*상품중분류ID*/
             , PD_LCLSF_ID /*상품소분류ID*/
             , PD_DCLSF_ID /*상품세분류ID*/
             , STLM_TP_CD /*결제유형코드*/
             , CRNCY_DV_CD /*통화구분코드*/
             , APY_EXCR /*적용환율*/
             , PD_BASE_AMT /*상품기준금액*/
             , FNL_AMT /*최종금액*/
             , VAT /*부가가치세*/
             , SELL_AMT /*판매금액*/
             , CNTR_AMT /*계약금액*/
             , ISTM_PCAM_AMT /*할부원금금액*/
             , ISTM_INT_AMT /*할부이자금액*/
             , MM_ISTM_AMT /*월할부금액*/
             , ACKMT_PERF_RT /*인정실적율*/
             , ACKMT_PERF_AMT /*인정실적금액*/
             , SPP_DUEDT /*배송예정일자*/
             , RESUB_YN /*재구독여부*/
             , RSTL_YN /*재약정여부*/
             , FRISU_YN /*무상여부*/
             , SMTPL_ID /*스마트플랜ID*/
             , SMTPL_SN /*스마트플랜일련번호*/
             , BF_ORD_NO /*이전주문번호*/
             , CNTR_CH_RCP_ID /*계약변경접수ID*/
             , CNTR_CH_SN /*계약변경일련번호*/
             , DTA_DL_YN /*데이터삭제여부*/
             , FST_RGST_DTM /*최초등록일시*/
             , FST_RGST_USR_ID /*최초등록사용자ID*/
             , FST_RGST_PRG_ID /*최초등록프로그램ID*/
             , FST_RGST_DEPT_ID /*최초등록부서ID*/
             , FNL_MDFC_DTM /*최종수정일시*/
             , FNL_MDFC_USR_ID /*최종수정사용자ID*/
             , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
             , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
             , BOO_SELL_TP_CD /*예약판매유형코드*/
             , FEE_FXAM_YN /*수수료정액여부*/
             , FRISU_DSB_TP_CD /*무상지급유형코드*/
             , CNTR_CH_DTL_AK_CN /*계약변경상세요청내용*/
             , CNTRW_TP_CD /*계약서유형코드*/
             , TXINV_PBL_OJ_YN /*세금계산서발행대상여부*/
             , FEE_ACKMT_CT /*수수료인정건수*/
             , CVT_PERF_AMT /*환산실적금액*/
             , FEE_ACKMT_BASE_AMT /*수수료인정기준금액*/
             , SELL_TP_DTL_CD /*판매유형상세코드*/
             , SELL_DSC_DV_CD /*판매할인구분코드*/
             , SELL_DSCR_CD /*판매할인율코드*/
             , SELL_DSC_CTR_AMT /*판매할인조정금액*/
             , SELL_DSC_TP_CD /*판매할인유형코드*/
             , DSC_AMT /*할인금액*/
             , CNTRAM_DSC_AMT /*계약금할인금액*/
             , CRP_UC_AMT /*법인미수금액*/
             , SELL_FEE /*판매수수료*/
             , ALNCMP_CD /*제휴사코드*/
             , ALNCMP_CNTR_DRM_VAL /*제휴사계약식별값*/
          FROM TB_SSCT_CNTR_DTL
          WHERE CNTR_NO = #{cntrNo}
            AND CNTR_SN = #{cntrSn}
    </insert>

    <insert id="insertProductOutOfStorageIz">
        INSERT INTO TB_SSSO_PDCT_IDNO_OSTR_IZ ( /* 제품고유번호출고내역 */
                                                CNTR_NO /* 계약번호 */
                                              , CNTR_SN /* 계약일련번호 */
                                              , OSTR_SN /* 출고일련번호 */
                                              , SELL_TP_CD /* 판매유형코드 */
                                              , OSTR_RQDT /* 출고요청일자 */
                                              , PDCT_IDNO /* 제품고유번호 */
                                              , SPP_BZS_MODEL_ID /* 배송업체모델ID */
                                              , OSTR_MTR_DV_CD /* 출고자료구분코드 */
                                              , SPP_PROCS_BZS_CD /* 배송처리업체코드 */
        <include refid="COMMON.insertSystemField"/>)
        VALUES ( #{cntrNo}
               , #{cntrSn}
               /*FIXME: 출고일련번호를 어떻게 가져갈지 아직 불확실함.*/
               , COALESCE(0, (SELECT COALESCE(MAX(OSTR_SN), 0) + 1 FROM TB_SSSO_PDCT_IDNO_OSTR_IZ WHERE CNTR_NO = #{cntrNo} AND CNTR_SN = #{cntrSn}))
               , #{sellTpCd}
               , TO_CHAR(SYSDATE, 'YYYYMMDD')
               , #{pdctIdno}
               , #{sppBzsModelId}
               , '1'
               , '3'
        <include refid="COMMON.insertSystemFieldValue"/>)
    </insert>

    <insert id="insertInvoiceProcessIz">
        INSERT INTO TB_SSSO_SPP_BZS_IVC_PROCS_IZ ( /* 배송업체송장처리내역 */
                                                   SPP_BZS_PROCS_ID /* 배송업체처리ID */
                                                 , CNTR_NO /* 계약번호 */
                                                 , CNTR_SN /* 계약일련번호 */
                                                 , SPP_PROCS_BZS_CD /* 배송처리업체코드 */
                                                 , SPP_BZS_ORD_ID /* 배송업체주문ID */
                                                 , SPP_BZS_ORD_RGST_DTM /* 배송업체주문호출일시 */
                                                 , SPP_FSH_RGST_DTM /* 배송완료호출일시 */
                                                 , SPP_FSH_DT /* 배송완료일시 */
        <include refid="COMMON.insertSystemField"/>)
        VALUES ( (SELECT NVL(MAX(TO_NUMBER(SPP_BZS_PROCS_ID)), 0) + 1 FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ)
               , #{cntrNo}
               , #{cntrSn}
               , '3'
               , #{sppBzsOrdId}
               , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
               , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
               , #{sppFshDt}
        <include refid="COMMON.insertSystemFieldValue"/>)
    </insert>

    <select id="selectInvoiceProcessIzPk" resultType="java.lang.String">
        SELECT MAX(TO_NUMBER(SPP_BZS_PROCS_ID))
          FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SPP_BZS_ORD_ID = #{sppBzsOrdId}
           AND SPP_FSH_DT = #{sppFshDt}
    </select>


    <insert id="insertInvoiceProcessHistory">
        INSERT INTO TB_SSSO_SPP_BZS_IVC_PROCS_HIST ( SPP_BZS_PROCS_ID /*배송업체처리ID*/
                                                   , CNTR_NO /*계약번호*/
                                                   , CNTR_SN /*계약일련번호*/
                                                   , SPP_PROCS_BZS_CD /*배송처리업체코드*/
                                                   , SPP_BZS_ORD_ID /*배송업체주문ID*/
                                                   , SPP_BZS_PD_ID /*배송업체상품ID*/
                                                   , BAT_WK_FSH_DTM /*배치작업완료일시*/
                                                   , SPP_IVC_NO /*배송송장번호*/
                                                   , DTA_DL_YN /*데이터삭제여부*/
                                                   , FST_RGST_DTM /*최초등록일시*/
                                                   , FST_RGST_USR_ID /*최초등록사용자ID*/
                                                   , FST_RGST_PRG_ID /*최초등록프로그램ID*/
                                                   , FST_RGST_DEPT_ID /*최초등록부서ID*/
                                                   , FNL_MDFC_DTM /*최종수정일시*/
                                                   , FNL_MDFC_USR_ID /*최종수정사용자ID*/
                                                   , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
                                                   , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
                                                   , CH_SN /*변경일련번호*/
                                                   , SPP_BZS_ORD_RGST_DTM /*배송업체주문등록일시*/
                                                   , SPP_FSH_RGST_DTM /*배송완료등록일시*/
                                                   , SPP_FSH_DT /*배송완료일자*/
                                                   , SELL_TP_CD /*판매유형코드*/
                                                   , BF_ORD_NO /*이전주문번호*/
        <include refid="COMMON.insertSystemField"/>
        )
        SELECT SPP_BZS_PROCS_ID /*배송업체처리ID*/
             , CNTR_NO /*계약번호*/
             , CNTR_SN /*계약일련번호*/
             , SPP_PROCS_BZS_CD /*배송처리업체코드*/
             , SPP_BZS_ORD_ID /*배송업체주문ID*/
             , SPP_BZS_PD_ID /*배송업체상품ID*/
             , BAT_WK_FSH_DTM /*배치작업완료일시*/
             , SPP_IVC_NO /*배송송장번호*/
             , DTA_DL_YN /*데이터삭제여부*/
             , FST_RGST_DTM /*최초등록일시*/
             , FST_RGST_USR_ID /*최초등록사용자ID*/
             , FST_RGST_PRG_ID /*최초등록프로그램ID*/
             , FST_RGST_DEPT_ID /*최초등록부서ID*/
             , FNL_MDFC_DTM /*최종수정일시*/
             , FNL_MDFC_USR_ID /*최종수정사용자ID*/
             , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
             , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
             , 0 /*변경일련번호*/
             , SPP_BZS_ORD_RGST_DTM /*배송업체주문등록일시*/
             , SPP_FSH_RGST_DTM /*배송완료등록일시*/
             , SPP_FSH_DT /*배송완료일자*/
             , SELL_TP_CD /*판매유형코드*/
             , BF_ORD_NO /*이전주문번호*/
        <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ
         WHERE SPP_BZS_PROCS_ID = #{sppBzsProcsId}
    </insert>
    <!-- endregion 확정일 -->

    <!-- region 미설치 -->
    <select id="selectNotInstalledIzs"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchNotInstalledRes">
        SELECT T_CNTR_DTL.CNTR_NO
             , T_CNTR_DTL.CNTR_SN
             , T_CNTR_CST_BAS.CST_KNM AS CNTR_CST_KNM
             , (SELECT SPP_BZS_ORD_ID
                  FROM TB_SSOP_SPP_BZS_ULD_HIST
                 WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND SPP_BZS_ORD_ID IS NOT NULL
                   AND FST_RGST_DTM = (SELECT MAX(FST_RGST_DTM)
                                         FROM TB_SSOP_SPP_BZS_ULD_HIST
                                        WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                                          AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                                          AND SPP_BZS_ORD_ID IS NOT NULL)) AS SPP_BZS_ORD_ID
             , T_PD_HCLSF_BAS.PD_CLSF_NM                                   AS PD_HCLSF_NM
             , T_PD_MCLSF_BAS.PD_CLSF_NM                                   AS PD_MCLSF_NM
             , T_CNTR_BAS.CNTR_CNFM_DTM
             , (SELECT BSDT
                  FROM TB_SSOP_SPP_BZS_ULD_HIST
                 WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND SPP_BZS_MNGT_ATC_CD = '10'
                   AND FST_RGST_DTM = (SELECT MAX(FST_RGST_DTM)
                                         FROM TB_SSOP_SPP_BZS_ULD_HIST
                                        WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                                          AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                                          AND SPP_BZS_MNGT_ATC_CD = '10')) AS DUEDT
             , T_MM_PRTNR_IZ.OG_CD AS PRTNR_OG_CD
             , T_MM_PRTNR_IZ.PRTNR_NO
             , T_MM_PRTNR_IZ.PRTNR_KNM
             , (SELECT SPP_MO_CN
                  FROM TB_SSOP_SPP_BZS_ULD_HIST
                 WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND SPP_BZS_MNGT_ATC_CD = '30'
                   AND FST_RGST_DTM = (SELECT MAX(FST_RGST_DTM)
                                         FROM TB_SSOP_SPP_BZS_ULD_HIST
                                        WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                                          AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                                          AND SPP_BZS_MNGT_ATC_CD = '30')) AS CAN_RSON
          FROM TB_SSCT_CNTR_DTL                       T_CNTR_DTL
               INNER JOIN TB_SSCT_CNTR_BAS            T_CNTR_BAS
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               INNER JOIN TB_PDBS_PD_BAS              T_PD_BAS
               ON T_PD_BAS.DTA_DL_YN = 'N'
                   AND T_PD_BAS.PD_CD = T_CNTR_DTL.BASE_PD_CD
               INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL     T_PD_ECOM_PRP_DTL
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_PD_BAS.PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP'
                   AND T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S' /* 삼성전자제품 */
               INNER JOIN TB_PDBS_PD_CLSF_BAS         T_PD_HCLSF_BAS
               ON T_PD_HCLSF_BAS.DTA_DL_YN = 'N'
                   AND T_PD_HCLSF_BAS.PD_CLSF_ID = T_PD_BAS.PD_HCLSF_ID
               INNER JOIN TB_PDBS_PD_CLSF_BAS         T_PD_MCLSF_BAS
               ON T_PD_MCLSF_BAS.DTA_DL_YN = 'N'
                   AND T_PD_MCLSF_BAS.PD_CLSF_ID = T_PD_BAS.PD_MCLSF_ID
               INNER JOIN TB_OGBS_MM_PRTNR_IZ         T_MM_PRTNR_IZ
               ON T_MM_PRTNR_IZ.DTA_DL_YN = 'N'
                   AND T_MM_PRTNR_IZ.BASE_YM = SUBSTR(T_CNTR_BAS.CNTR_RCP_FSH_DTM, 1, 6)
                   AND T_MM_PRTNR_IZ.OG_TP_CD = T_CNTR_BAS.SELL_OG_TP_CD
                   AND T_MM_PRTNR_IZ.PRTNR_NO = T_CNTR_BAS.SELL_PRTNR_NO
               INNER JOIN TB_CUBS_CST_BAS             T_CNTR_CST_BAS
               ON T_CNTR_CST_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_CST_BAS.CST_NO = T_CNTR_BAS.CNTR_CST_NO
               LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T_CNTR_WELLS_DTL
               ON T_CNTR_WELLS_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_WELLS_DTL.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_WELLS_DTL.CNTR_SN = T_CNTR_DTL.CNTR_SN
         WHERE T_CNTR_DTL.DTA_DL_YN = 'N'
           AND T_CNTR_DTL.CTT_RS_CD NOT IN ('93', '94', '95', '96', '97', '98')
           AND T_CNTR_DTL.CNTR_PD_ENDDT IS NULL
           AND T_CNTR_WELLS_DTL.CPS_DT IS NULL
           AND NOT EXISTS(SELECT 1
                            FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                           WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                             AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                             AND DTA_DL_YN = 'N'
             )
           <if test="@MybatisUtils@isNotEmpty(strtdt) and @MybatisUtils@isNotEmpty(enddt)"><trim>
               AND T_CNTR_BAS.CNTR_CNFM_DTM BETWEEN #{strtdt} || '000000' AND #{enddt} || '235959'
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(cntrNo)"><trim>
               AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(cntrSn)"><trim>
               AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(cntrCstKnm)"><trim>
               AND T_CNTR_CST_BAS.CST_KNM = #{cntrCstKnm}
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(strtOgCd) and @MybatisUtils@isNotEmpty(endOgCd)"><trim>
               AND T_MM_PRTNR_IZ.OG_CD BETWEEN #{strtOgCd} AND #{endOgCd}
           </trim></if>

    </select>

    <select id="selectSecNistlValidation"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dvo.WcteSecNistlValidationDvo">
        SELECT T_CNTR_DTL.CNTR_NO
             , T_CNTR_DTL.CNTR_SN
             , T_CNTR_DTL.SELL_TP_CD
             , CASE
                   WHEN T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S'
                       THEN 'Y'
                       ELSE ''
               END AS SEC_PD_YN /*삼성전자배송제품여부*/
             , CASE
                   WHEN T_CNTR_DTL.CTT_RS_CD NOT IN ('93', '94', '95', '96', '97', '98')
                       THEN 'Y'
                       ELSE ''
               END AS CAN_OR_REJ_YN /*취소 혹은 방문거부*/
             , T_CNTR_DTL.CNTR_PD_ENDDT
          FROM TB_SSCT_CNTR_DTL                        T_CNTR_DTL
               LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T_PD_ECOM_PRP_DTL /*상품각사속성안내*/
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_CNTR_DTL.BASE_PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP'
         WHERE T_CNTR_DTL.DTA_DL_YN = 'N'
           AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
           AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
           AND T_CNTR_DTL.CNTR_PD_ENDDT IS NULL
           AND NOT EXISTS(SELECT 1
                            FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                           WHERE CNTR_NO = T_CNTR_DTL.CNTR_NO
                             AND CNTR_SN = T_CNTR_DTL.CNTR_SN
                             AND DTA_DL_YN = 'N'
             )
    </select>

    <insert id="insertNotInstalledIz">
        INSERT INTO TB_SSOP_SPP_BZS_ULD_HIST ( SPP_BZS_ULD_ID /*배송업체업로드ID*/
                                             , CNTR_NO /*계약번호*/
                                             , CNTR_SN /*계약일련번호*/
                                             , SPP_PROCS_BZS_CD /*배송처리업체코드*/
                                             , SPP_BZS_MNGT_ATC_CD /*배송업체관리항목코드*/
                                             , SPP_MO_CN /*배송메모내용*/
                                             , SELL_TP_CD /*판매유형코드*/
        <include refid="COMMON.insertSystemField"/>
        )
        VALUES ( (SELECT LPAD(NVL(MAX(SPP_BZS_ULD_ID),0)+1, 15, 0) FROM TB_SSOP_SPP_BZS_ULD_HIST)/*배송업체업로드ID*/
               , #{cntrNo} /*계약번호*/
               , #{cntrSn} /*계약일련번호*/
               , '3' /*배송처리업체코드: 3.삼성물류*/
               , '30' /*배송업체관리항목코드: 30.미설치*/
               , #{canRson} /*배송메모내용*/
               , #{sellTpCd} /*판매유형코드*/
        <include refid="COMMON.insertSystemFieldValue"/>
               )
    </insert>
    <!-- endregion 미설치 -->

    <!-- region 배송 -->
    <select id="selectSecPdBycfs" resultType="com.kyowon.sms.wells.web.contract.salesstatus.dvo.WcteSecPdBycfDvo">
        SELECT T_PD_BAS.PD_MCLSF_ID
             , (SELECT PD_CLSF_NM FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T_PD_BAS.PD_MCLSF_ID) AS PD_MCLSF_NM
             , T_PD_BAS.PD_CD
             , T_PD_BAS.PD_NM
          FROM TB_PDBS_PD_BAS                     T_PD_BAS
               INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T_PD_ECOM_PRP_DTL
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP' /* 배송 코드*/
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_PD_BAS.PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S' /* 삼성전자 제품 */
         WHERE T_PD_BAS.DTA_DL_YN = 'N'
           AND T_PD_BAS.PD_TP_CD = 'P' /* 기준 상품*/
    </select>

    <select id="selectShippings"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchShippingRes">
        SELECT
             (SELECT 1
                FROM DUAL
               WHERE EXISTS (
                         SELECT 1
                           FROM TB_SSCT_SELL_LM_OJ_IZ A
                          INNER JOIN TB_SSCT_CNTR_BAS B
                             ON B.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND B.DTA_DL_YN = 'N'
                          WHERE A.DTA_DL_YN = 'N'
                            AND A.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND A.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND B.CNTR_CST_NO = T2.CNTR_CST_NO
                            )) AS BLK_YN1
            ,(SELECT 1
                FROM DUAL
               WHERE EXISTS (
                         SELECT 1
                           FROM TB_SSCT_SELL_LM_OJ_IZ A
                          INNER JOIN TB_SSCT_CNTR_BAS B
                             ON B.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND B.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_DTL C
                             ON C.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND C.CNTR_SN = A.SELL_LM_CNTR_SN
                            AND C.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_ADR_REL D
                             ON D.DTL_CNTR_NO = C.CNTR_NO
                            AND D.DTL_CNTR_SN = C.CNTR_SN
                            AND D.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND D.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND D.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_ADRPC_BAS E
                             ON E.CNTR_ADRPC_ID = D.CNTR_ADRPC_ID
                            AND E.DTA_DL_YN = 'N'
                          WHERE A.DTA_DL_YN = 'N'
                            AND (E.RCGVP_KNM = T22.CST_KNM OR E.RCGVP_KNM = T7.RCGVP_KNM )
                            )) AS BLK_YN2
            ,(SELECT 1
                FROM DUAL
               WHERE EXISTS (
                         SELECT 1
                           FROM TB_SSCT_SELL_LM_OJ_IZ A
                          INNER JOIN TB_SSCT_CNTR_BAS B
                             ON B.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND B.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_DTL C
                             ON C.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND C.CNTR_SN = A.SELL_LM_CNTR_SN
                            AND C.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_ADR_REL D
                             ON D.DTL_CNTR_NO = C.CNTR_NO
                            AND D.DTL_CNTR_SN = C.CNTR_SN
                            AND D.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND D.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND D.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_ADRPC_BAS E
                             ON E.CNTR_ADRPC_ID = D.CNTR_ADRPC_ID
                            AND E.DTA_DL_YN = 'N'
                          WHERE A.DTA_DL_YN = 'N'
                            AND E.CRAL_LOCARA_TNO = T7.CRAL_LOCARA_TNO
                            AND E.MEXNO_ENCR = T7.MEXNO_ENCR
                            AND E.CRAL_IDV_TNO = T7.CRAL_IDV_TNO
                            )) AS BLK_YN3
            ,(SELECT 1
                FROM DUAL
               WHERE EXISTS (
                         SELECT 1
                           FROM TB_SSCT_SELL_LM_OJ_IZ A
                          INNER JOIN TB_SSCT_CNTR_BAS B
                             ON B.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND B.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_DTL C
                             ON C.CNTR_NO = A.SELL_LM_CNTR_NO
                            AND C.CNTR_SN = A.SELL_LM_CNTR_SN
                            AND C.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_ADR_REL D
                             ON D.DTL_CNTR_NO = C.CNTR_NO
                            AND D.DTL_CNTR_SN = C.CNTR_SN
                            AND D.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND D.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                            AND D.DTA_DL_YN = 'N'
                          INNER JOIN TB_SSCT_CNTR_ADRPC_BAS E
                             ON E.CNTR_ADRPC_ID = D.CNTR_ADRPC_ID
                            AND E.DTA_DL_YN = 'N'
                          WHERE A.DTA_DL_YN = 'N'
                            AND E.ADR_ID = T7.ADR_ID
                            )) AS BLK_YN4
            , CASE WHEN T11.CTT_FSH_DTM IS NOT NULL THEN SUBSTR(T11.CTT_FSH_DTM,1,8)
                   ELSE SUBSTR(T2.CNTR_CNFM_DTM,1,8)
                   END AS CTT_OR_CNFM_DTM
            , T1.CNTR_NO
            , T1.CNTR_SN
            , T5.SPP_BZS_ORD_ID
            , T9.OJ_DTL_CNTR_NO
            , T9.OJ_DTL_CNTR_SN
            , T7.RCGVP_KNM
            , T8.NEW_ADR_ZIP AS ZIP
            , NVL(T8.RNADR , T8.LTN_ADR) AS ADR
            , NVL(T8.RDADR, T8.LTN_DTL_ADR) AS DTL_ADR
            , T1.PD_MCLSF_ID
            , T31.PD_CLSF_NM AS PD_MCLSF_NM
            , T3.PD_CD
            , T3.PD_NM
            , T7.CRAL_LOCARA_TNO
            , T7.MEXNO_ENCR
            , T7.CRAL_IDV_TNO
            , T21.CRAL_LOCARA_TNO AS PRTNR_CRAL_LOCARA_TNO
            , T21.MEXNO_ENCR AS PRTNR_MEXNO_ENCR
            , T21.CRAL_IDV_TNO AS PRTNR_CRAL_IDV_TNO
            , T1.SELL_TP_CD
            , F_CMZ_CD_NM('TNT_EDU', 'SELL_TP_CD', T1.SELL_TP_CD) AS SELL_TP_NM
          FROM TB_SSCT_CNTR_DTL T1
          LEFT OUTER JOIN TB_SSOP_CTT_BAS T11
            ON T11.CTT_OJ_ID = T1.CTT_OJ_ID
           AND T11.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_BAS T2
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_OGBS_PRTNR_BAS T21
            ON T21.PRTNR_NO = T2.SELL_PRTNR_NO
           AND T21.OG_TP_CD = T2.SELL_OG_TP_CD
           AND T21.DTA_DL_YN = 'N'
         INNER JOIN TB_CUBS_CST_BAS T22
            ON T22.CST_NO = T2.CNTR_CST_NO
           AND T22.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_BAS T3
            ON T3.PD_CD = T1.BASE_PD_CD
           AND T3.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_CLSF_BAS T31
            ON T31.PD_CLSF_ID = T3.PD_MCLSF_ID
           AND T31.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T4
            ON T4.PD_CD = T1.BASE_PD_CD
           AND T4.PD_EXTS_PRP_GRP_CD = 'SPP'
           AND T4.PD_PRP_VAL02 = 'S'
           AND T4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSSO_SPP_BZS_IVC_PROCS_IZ T5
            ON T5.CNTR_NO = T1.CNTR_NO
           AND T5.CNTR_SN = T1.CNTR_SN
           AND T5.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_ADR_REL T6
            ON T6.DTL_CNTR_NO = T1.CNTR_NO
           AND T6.DTL_CNTR_SN = T1.CNTR_SN
           AND T6.ADRPC_TP_CD IN ('2','3')
           AND T6.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
           AND T6.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
           AND T6.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS T7
            ON T7.CNTR_ADRPC_ID = T6.CNTR_ADRPC_ID
           AND T7.DTA_DL_YN = 'N'
         INNER JOIN TB_GBCO_ADR_BAS T8
            ON T8.ADR_ID = T7.ADR_ID
           AND T8.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_REL T9
            ON T9.BASE_DTL_CNTR_NO = T1.CNTR_NO
           AND T9.BASE_DTL_CNTR_SN = T1.CNTR_SN
           AND T9.CNTR_REL_DTL_CD = '218'
           AND T9.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
           AND T9.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
           AND T9.DTA_DL_YN = 'N'
         WHERE T1.DTA_DL_YN = 'N'
           AND T1.CNTR_DTL_STAT_CD = '101'
        <if test="@MybatisUtils@isNotEmpty(strtdt) and @MybatisUtils@isNotEmpty(enddt)"><trim>
           AND T2.CNTR_CNFM_DTM <![CDATA[>=]]> #{strtdt} || '000000'
           AND T2.CNTR_CNFM_DTM <![CDATA[<=]]> #{enddt} || '235959'
        </trim></if>
        <if test="@MybatisUtils@isEmpty(pdCds) and @MybatisUtils@isNotEmpty(pdMclsfIds)"><trim>
           AND T1.PD_MCLSF_ID IN
           <foreach collection="pdMclsfIds" item="pdMclsfId" separator="," open="(" close=")">
               #{pdMclsfId}
           </foreach>
        </trim></if>
        <if test="@MybatisUtils@isNotEmpty(pdCds)"><trim>
           AND T1.BASE_PD_CD IN
           <foreach collection="pdCds" item="pdCd" separator="," open="(" close=")">
               #{pdCd}
           </foreach>
        </trim></if>
        <if test="@MybatisUtils@equals(isCombi, 'Y')"><trim>
           /* 콤비엑셀 조회의 경우 */
           AND T1.BASE_PD_CD IN ('WP02120302','WP02120313','WP02120586', 'WP02120589', 'WP02120592', 'WP02120069','WP02120428')
        </trim></if>
        ORDER BY T2.CNTR_CNFM_DTM DESC
    </select>

    <select id="selectFreeASs"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchFreeAsRes">
        SELECT T.CNTR_NO /* 계약번호 */
             , T.CNTR_SN /* 계약일련번호 */
             , T.CNTR_CST_KNM /* 계약자명 */
             , T.BASE_PD_CD                                                               AS PD_CD/* 상품코드 */
             , T.PD_NM /* 상품명 */
             , T.PDCT_IDNO /* 제조번호 */
             , T.CNTR_CNFM_DTM /* 계약일 */
             , T.IST_DT /* 설치일 */
             , T.CNTR_PD_ENDDT /* 렌탈만료일 */
             , T.CAN_PD_ENDDT /* 취소일 */
             , T.CNTR_DTL_STAT_CD /* 계약상태코드 */
             , T.FRISU_AS_MCN /* 무상A/S기간 */
             , T.SS_FRISU_AS_MCN /* 삼성 부담 무상A/S기간 */
             , (T.FRISU_AS_MCN - T.SS_FRISU_AS_MCN)                                       AS KW_FRISU_AS_MCN /* 교원 부담 무상A/S기간 */
             , TO_CHAR(ADD_MONTHS(TO_DATE(T.CNTR_PD_STRTDT), T.FRISU_AS_MCN),
                       'YYYYMMDD')                                                        AS FRISU_END_DT /* 무상A/S 종료일 */
             , T.SL_STP_YN /* 매출중지여부 */
             , T.CNTR_PD_STRTDT /* 계약상품시작일자 */
             , CASE
                   WHEN T.FRISU_AS_MCN > T.SS_FRISU_AS_MCN THEN 'Y'
                                                           ELSE 'N'
               END                                                                        AS AFTER_TG_YN /* 사후정산 대상여부 */
             , CASE
                   WHEN T.FRISU_AS_MCN > T.SS_FRISU_AS_MCN
                       THEN TO_CHAR(ADD_MONTHS(TO_DATE(T.CNTR_PD_STRTDT), T.SS_FRISU_AS_MCN + 1), 'YYYYMMDD')
               END                                                                        AS AFTER_TG_ST_DT /* 사후정산 시작일 */
             , CASE
                   WHEN T.FRISU_AS_MCN > T.SS_FRISU_AS_MCN
                       THEN TO_CHAR(ADD_MONTHS(TO_DATE(T.CNTR_PD_STRTDT), T.FRISU_AS_MCN + 1) - 1, 'YYYYMMDD')
               END                                                                        AS AFTER_TG_ED_DT /* 사후정산 종료월 */
             , T.DLQ_YN /* 연체여부 */
             , T.EOT_DLQ_AMT /* 연체금액 */
          FROM (SELECT T_PDCT_IDNO_OSTR_IZ.CNTR_NO
                     , T_PDCT_IDNO_OSTR_IZ.CNTR_SN
                     , T_CNTR_CST_BAS.CST_KNM AS CNTR_CST_KNM
                     , T_CNTR_DTL.BASE_PD_CD
                     , T_PD_BAS.PD_NM
                     , T_PDCT_IDNO_OSTR_IZ.PDCT_IDNO
                     , T_CNTR_BAS.CNTR_CNFM_DTM
                     , T_CNTR_WELLS_DTL.IST_DT
                     , T_CNTR_DTL.CNTR_PD_STRTDT
                     , TO_CHAR(ADD_MONTHS(TO_DATE(T_CNTR_WELLS_DTL.IST_DT), T_CNTR_DTL.CNTR_PTRM),'YYYYMMDD')   AS CNTR_PD_ENDDT
                     , CASE
                           WHEN T_CNTR_DTL.CNTR_DTL_STAT_CD = '303' THEN T_CNTR_DTL.CNTR_PD_ENDDT
                                                                    ELSE ''
                       END                    AS CAN_PD_ENDDT
                     , T_CNTR_DTL.CNTR_DTL_STAT_CD
                     , CASE
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20220417000000'
                               OR T_CNTR_EX_OJ_BAS.EX_PROCS_ID IS NOT NULL
                                                                            THEN T_CNTR_DTL.CNTR_PTRM
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210902000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL = '02002' /* AS-IS 'N' 에어컨 */
                                                                            THEN 24
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210902000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL <![CDATA[<>]]> '02002'
                                                                            THEN 12
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210315000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL IN ('02002', '04006', '04003') /* AS-IS 'N','S','J' */
                                                                            THEN 36
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210315000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL IN ('04004', '04005', '05004', '05005') /* AS-IS 'I', 'H', 'O', 'P' */
                                                                            THEN 12
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20180531000000' THEN 60
                                                                            ELSE 0
                       END                    AS FRISU_AS_MCN /*무상 AS 기간*/
                     , CASE
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20220417000000'
                               OR T_CNTR_EX_OJ_BAS.EX_PROCS_ID IS NOT NULL
                               THEN T_CNTR_DTL.CNTR_PTRM
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210902000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL = '02002' /* AS-IS 'N' 에어컨 */
                               THEN 24
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210902000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL <![CDATA[<>]]> '02002'
                               THEN 12
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210315000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL = '02002'
                               THEN 24
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20210315000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL
                                   IN ('04006', '04003', '04004', '04005', '05004', '05005') /* AS-IS 'S','J','I','H','O','P' */
                               THEN 12
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20180531000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL = '02002'
                               THEN 24
                           WHEN T_CNTR_BAS.CNTR_CNFM_DTM > '20180531000000'
                               AND T_PD_CLSF_BAS.REF_PD_CLSF_VAL <![CDATA[<>]]> '02002'
                               THEN 12
                               ELSE 0
                       END                    AS SS_FRISU_AS_MCN /*삼성 부담 무상 AS 기간*/
                     , T_LSTMM_WELLS_SL_MM_CL_IZ.SL_STP_YN
                     , CASE
                           WHEN T_LSTMM_DLQ_BAS.EOT_DLQ_AMT > 0 THEN 'Y'
                                                                ELSE 'N'
                       END                    AS DLQ_YN
                     , T_LSTMM_DLQ_BAS.EOT_DLQ_AMT
                  FROM TB_SSSO_PDCT_IDNO_OSTR_IZ                 T_PDCT_IDNO_OSTR_IZ /* 제품고유번호출고내역  CNTR_NO, CNTR_SN, OSTR_SN*/
                       INNER JOIN TB_SSCT_CNTR_DTL               T_CNTR_DTL /* 계약상세 */
                       ON T_CNTR_DTL.DTA_DL_YN = 'N'
                           AND T_CNTR_DTL.CNTR_NO = T_PDCT_IDNO_OSTR_IZ.CNTR_NO
                           AND T_CNTR_DTL.CNTR_SN = T_PDCT_IDNO_OSTR_IZ.CNTR_SN
                       INNER JOIN TB_SSCT_CNTR_BAS               T_CNTR_BAS /* 계약기본 */
                       ON T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
                           AND T_CNTR_BAS.DTA_DL_YN = 'N'
                       INNER JOIN TB_CUBS_CST_BAS                T_CNTR_CST_BAS /* 고객기본 */
                       ON T_CNTR_CST_BAS.CST_NO = T_CNTR_BAS.CNTR_CST_NO
                           AND T_CNTR_CST_BAS.DTA_DL_YN = 'N'
                       INNER JOIN TB_PDBS_PD_BAS                 T_PD_BAS /* 상품기본 */
                       ON T_PD_BAS.DTA_DL_YN = 'N'
                           AND T_PD_BAS.PD_CD = T_CNTR_DTL.BASE_PD_CD
                       INNER JOIN TB_PDBS_PD_CLSF_BAS            T_PD_CLSF_BAS /* 상품분류기본 PD_CLSF_ID */
                       ON T_PD_CLSF_BAS.DTA_DL_YN = 'N'
                           AND T_PD_CLSF_BAS.PD_CLSF_ID = T_PD_BAS.PD_MCLSF_ID
                       INNER JOIN TB_SSCT_CNTR_WELLS_DTL         T_CNTR_WELLS_DTL /* 계약WELLS상세 */
                       ON T_CNTR_WELLS_DTL.DTA_DL_YN = 'N'
                           AND T_CNTR_WELLS_DTL.CNTR_NO = T_CNTR_DTL.CNTR_NO
                           AND T_CNTR_WELLS_DTL.CNTR_SN = T_CNTR_DTL.CNTR_SN
                       LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ T_LSTMM_WELLS_SL_MM_CL_IZ /* WELLS매출월마감내역 SL_CL_YM, CNTR_NO, CNTR_SN*/
                       ON T_LSTMM_WELLS_SL_MM_CL_IZ.CNTR_NO = T_CNTR_DTL.CNTR_NO
                           AND T_LSTMM_WELLS_SL_MM_CL_IZ.CNTR_SN = T_CNTR_DTL.CNTR_SN
                           AND T_LSTMM_WELLS_SL_MM_CL_IZ.SL_CL_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
                       LEFT OUTER JOIN TB_CBCL_DLQ_BAS           T_LSTMM_DLQ_BAS /* 연체기본 PERF_YM, CNTR_NO, CNTR_SN */
                       ON T_LSTMM_DLQ_BAS.DTA_DL_YN = 'N'
                           AND T_LSTMM_DLQ_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
                           AND T_LSTMM_DLQ_BAS.CNTR_SN = T_CNTR_DTL.CNTR_SN
                           AND T_LSTMM_DLQ_BAS.PERF_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
                       LEFT OUTER JOIN TB_SSCT_CNTR_EX_OJ_BAS    T_CNTR_EX_OJ_BAS /* 계약예외대상기본 */
                       ON T_CNTR_EX_OJ_BAS.DTA_DL_YN = 'N'
                           AND T_CNTR_EX_OJ_BAS.VL_END_DTM >= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                           AND T_CNTR_EX_OJ_BAS.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                           AND T_CNTR_EX_OJ_BAS.EX_PROCS_CD = 'W05'
                           AND T_CNTR_EX_OJ_BAS.EX_PROCS_OJ_DRM_VAL = T_CNTR_DTL.CNTR_NO || T_CNTR_DTL.CNTR_SN
                 WHERE T_PDCT_IDNO_OSTR_IZ.DTA_DL_YN = 'N'
                   AND T_PDCT_IDNO_OSTR_IZ.SELL_TP_CD = '2' /* 판매유형코드: 렌탈/리스 */
                   AND T_PDCT_IDNO_OSTR_IZ.SPP_PROCS_BZS_CD = '3' /* 배송처리업체코드: 삼성 */
                   <if test="@MybatisUtils@isNotEmpty(cntrCnfmStrtdt) and @MybatisUtils@isNotEmpty(cntrCnfmEnddt)"><trim>
                       AND T_CNTR_BAS.CNTR_CNFM_DTM <![CDATA[>=]]> #{cntrCnfmStrtdt} || '000000'
                       AND T_CNTR_BAS.CNTR_CNFM_DTM <![CDATA[<=]]> #{cntrCnfmEnddt} || '235959'
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(istStrtdt) and @MybatisUtils@isNotEmpty(istEnddt)"><trim>
                       AND T_CNTR_WELLS_DTL.IST_DT <![CDATA[>=]]> #{istStrtdt}
                       AND T_CNTR_WELLS_DTL.IST_DT <![CDATA[<=]]> #{istEnddt}
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(cntrDtlStatCd)"><trim>
                       AND T_CNTR_DTL.CNTR_DTL_STAT_CD = #{cntrDtlStatCd}
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(cntrNo) and @MybatisUtils@isNotEmpty(cntrSn)"><trim>
                       AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
                       AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(cntrCstKnm)"><trim>
                       AND T_CNTR_CST_BAS.CST_KNM = #{cntrCstKnm}
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(pdCd)"><trim>
                       AND T_CNTR_DTL.BASE_PD_CD = #{pdCd}
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(pdNm)"><trim>
                       AND T_PD_BAS.PD_NM LIKE '%' || #{pdNm} || '%'
                   </trim></if>
                   <if test="@MybatisUtils@isNotEmpty(pdctIdno)"><trim>
                       AND T_PDCT_IDNO_OSTR_IZ.PDCT_IDNO = #{pdctIdno}
                   </trim></if>
                 ) T
         <where>
             <if test="@MybatisUtils@equals(afterTgYn, 'Y')"><trim>
                 AND T.FRISU_AS_MCN <![CDATA[>]]> T.SS_FRISU_AS_MCN
                <if test="@MybatisUtils@isNotEmpty(afterTgBaseYm)"><trim>
                 AND ADD_MONTHS(TO_DATE(T.CNTR_PD_STRTDT), T.SS_FRISU_AS_MCN + 1) <![CDATA[<=]]> TO_DATE(#{afterTgBaseYm}, 'YYYYMM')
                 AND ADD_MONTHS(TO_DATE(T.CNTR_PD_STRTDT), T.FRISU_AS_MCN + 1) - 1 <![CDATA[>=]]> TO_DATE(#{afterTgBaseYm}, 'YYYYMM')
                </trim></if>
             </trim></if>
             <if test="@MybatisUtils@equals(afterTgYn, 'N')">
                 AND T.FRISU_AS_MCN <![CDATA[<=]]> T.SS_FRISU_AS_MCN
             </if>
         </where>
    </select>
    <!-- endregion 배송 -->

    <sql id="forTemplate">
        <if test="@MybatisUtils@isNotEmpty(strtdt) and @MybatisUtils@isNotEmpty(enddt)"><trim>
            AND T_CNTR_BAS.CNTR_CNFM_DTM BETWEEN #{strtdt} || '000000' AND #{enddt} || '235959'
        </trim></if>
        AND T_CNTR_DTL.PD_MCLSF_ID IN
        <foreach item="pdMclsfId" collection="pdMclsfIds" separator="," open="(" close=")">#{pdMclsfId}</foreach>
        AND T_CNTR_DTL.BASE_PD_CD IN
        <foreach item="basePdCd" collection="basePdCds" separator="," open="(" close=")">#{basePdCd}</foreach>
        ORDER BY T_CNTR_BAS.CNTR_CNFM_DTM DESC
    </sql>
</mapper>
